<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Finance Dashboard - Анализ заказов</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg-primary: #0f0f0f;
  --bg-secondary: #1a1a1a;
  --bg-card: #242424;
  --bg-hover: #2a2a2a;
  --text-primary: #ffffff;
  --text-secondary: #a0a0a0;
  --text-muted: #666666;
  --accent-success: #10b981;
  --accent-success-bg: rgba(16, 185, 129, 0.15);
  --accent-danger: #ef4444;
  --accent-danger-bg: rgba(239, 68, 68, 0.15);
  --accent-primary: #3b82f6;
  --accent-primary-bg: rgba(59, 130, 246, 0.15);
  --accent-warning: #f59e0b;
  --accent-mint: #14b8a6;
  --accent-mint-bg: rgba(20, 184, 166, 0.15);
  --border-color: #2a2a2a;
  --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
  --radius: 16px;
  --radius-sm: 8px;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  line-height: 1.6;
  min-height: 100vh;
}

.container {
  max-width: 1600px;
  margin: 0 auto;
  padding: 24px;
}

/* Header */
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 32px;
  padding-bottom: 24px;
  border-bottom: 1px solid var(--border-color);
}

.header-title {
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 24px;
  font-weight: 600;
}

.header-title i {
  color: var(--accent-mint);
  font-size: 28px;
}

.header-actions {
  display: flex;
  gap: 12px;
}

/* Summary Cards Grid */
.summary-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-bottom: 32px;
}

.summary-card {
  background: var(--bg-card);
  border-radius: var(--radius-sm);
  padding: 20px;
  border: 1px solid var(--border-color);
  transition: all 0.2s;
}

.summary-card:hover {
  background: var(--bg-hover);
  transform: translateY(-2px);
}

.summary-card.success {
  background: var(--accent-success-bg);
  border-color: var(--accent-success);
}

.summary-card.danger {
  background: var(--accent-danger-bg);
  border-color: var(--accent-danger);
}

.summary-card.primary {
  background: var(--accent-primary-bg);
  border-color: var(--accent-primary);
}

.summary-card.mint {
  background: var(--accent-mint-bg);
  border-color: var(--accent-mint);
}

.summary-label {
  font-size: 13px;
  color: var(--text-secondary);
  margin-bottom: 8px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.summary-value {
  font-size: 28px;
  font-weight: 700;
  margin-bottom: 4px;
}

.summary-card.success .summary-value {
  color: var(--accent-success);
}

.summary-card.danger .summary-value {
  color: var(--accent-danger);
}

.summary-card.primary .summary-value {
  color: var(--accent-primary);
}

.summary-card.mint .summary-value {
  color: var(--accent-mint);
}

.summary-change {
  font-size: 13px;
  color: var(--text-muted);
}

/* Main Grid Layout */
.main-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 24px;
  margin-bottom: 24px;
}

@media (max-width: 1200px) {
  .main-grid {
    grid-template-columns: 1fr;
  }
}

/* Section */
.section {
  background: var(--bg-card);
  border-radius: var(--radius);
  padding: 24px;
  border: 1px solid var(--border-color);
  margin-bottom: 24px;
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--border-color);
}

.section-title {
  font-size: 18px;
  font-weight: 600;
}

/* Upload Area */
.upload-area {
  border: 2px dashed var(--border-color);
  border-radius: var(--radius);
  padding: 40px;
  text-align: center;
  background: var(--bg-secondary);
  cursor: pointer;
  transition: all 0.3s;
  margin-bottom: 24px;
}

.upload-area:hover,
.upload-area.dragover {
  border-color: var(--accent-mint);
  background: var(--accent-mint-bg);
}

.upload-area i {
  font-size: 48px;
  color: var(--accent-mint);
  margin-bottom: 16px;
}

.upload-area h3 {
  font-size: 18px;
  margin-bottom: 8px;
}

.upload-area p {
  color: var(--text-secondary);
  font-size: 14px;
}

/* Budget Tracking Grid */
.budget-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 12px;
}

.budget-card {
  background: var(--bg-secondary);
  border-radius: var(--radius-sm);
  padding: 16px;
  border: 1px solid var(--border-color);
  transition: all 0.2s;
}

.budget-card:hover {
  border-color: var(--accent-mint);
}

.budget-card.success {
  border-color: var(--accent-success);
}

.budget-card.warning {
  border-color: var(--accent-warning);
}

.budget-card.danger {
  border-color: var(--accent-danger);
}

.budget-name {
  font-size: 13px;
  color: var(--text-secondary);
  margin-bottom: 8px;
}

.budget-amount {
  font-size: 20px;
  font-weight: 600;
  margin-bottom: 8px;
}

.budget-status {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 500;
  text-transform: uppercase;
}

.budget-status.success {
  background: var(--accent-success-bg);
  color: var(--accent-success);
}

.budget-status.warning {
  background: rgba(245, 158, 11, 0.15);
  color: var(--accent-warning);
}

.budget-status.danger {
  background: var(--accent-danger-bg);
  color: var(--accent-danger);
}

/* Debt Details */
.debt-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
}

.debt-card {
  background: var(--bg-secondary);
  border-radius: var(--radius-sm);
  padding: 20px;
  border: 1px solid var(--border-color);
}

.debt-name {
  font-size: 14px;
  color: var(--text-secondary);
  margin-bottom: 8px;
}

.debt-amount {
  font-size: 24px;
  font-weight: 700;
  color: var(--accent-danger);
}

.debt-info {
  font-size: 12px;
  color: var(--text-muted);
  margin-top: 4px;
}

/* Table */
.table-container {
  overflow-x: auto;
}

table {
  width: 100%;
  border-collapse: collapse;
}

thead {
  border-bottom: 1px solid var(--border-color);
}

th {
  text-align: left;
  padding: 12px 16px;
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-secondary);
  font-weight: 500;
  white-space: nowrap;
}

td {
  padding: 16px;
  border-bottom: 1px solid var(--border-color);
  font-size: 14px;
}

tr:hover td {
  background: var(--bg-hover);
}

.amount-positive {
  color: var(--accent-success);
  font-weight: 600;
}

.amount-negative {
  color: var(--accent-danger);
  font-weight: 600;
}

/* Parameter badges in table */
.param-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 500;
  white-space: nowrap;
}

.param-badge.time {
  background: rgba(59, 130, 246, 0.15);
  color: var(--accent-primary);
}

.param-badge.sqm {
  background: rgba(16, 185, 129, 0.15);
  color: var(--accent-success);
}

.param-badge.lm {
  background: rgba(245, 158, 11, 0.15);
  color: var(--accent-warning);
}

.param-badge.empty {
  color: var(--text-muted);
  font-size: 12px;
}

/* Controls */
.controls {
  display: flex;
  gap: 12px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.search-box {
  flex: 1;
  min-width: 200px;
  position: relative;
}

.search-box input {
  width: 100%;
  padding: 12px 16px 12px 40px;
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-sm);
  color: var(--text-primary);
  font-size: 14px;
}

.search-box i {
  position: absolute;
  left: 14px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-muted);
}

.filter-select {
  padding: 12px 16px;
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-sm);
  color: var(--text-primary);
  font-size: 14px;
  cursor: pointer;
}

/* Buttons */
.btn {
  padding: 10px 20px;
  border: none;
  border-radius: var(--radius-sm);
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.btn-primary {
  background: var(--accent-mint);
  color: white;
}

.btn-primary:hover {
  background: #0d9488;
}

.btn-danger {
  background: var(--accent-danger);
  color: white;
}

.btn-danger:hover {
  background: #dc2626;
}

.btn-secondary {
  background: var(--bg-secondary);
  color: var(--text-primary);
  border: 1px solid var(--border-color);
}

.btn-secondary:hover {
  background: var(--bg-hover);
}

/* Comments Button */
.comment-btn {
  width: 32px;
  height: 32px;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border-color);
  background: var(--bg-secondary);
  color: var(--text-secondary);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  position: relative;
}

.comment-btn:hover {
  border-color: var(--accent-mint);
  color: var(--accent-mint);
}

.comment-btn.has-comments {
  background: var(--accent-mint-bg);
  border-color: var(--accent-mint);
  color: var(--accent-mint);
}

.comment-badge {
  position: absolute;
  top: -4px;
  right: -4px;
  background: var(--accent-danger);
  color: white;
  font-size: 10px;
  padding: 2px 5px;
  border-radius: 10px;
  font-weight: 600;
}

/* Modal */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.8);
  backdrop-filter: blur(4px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s;
}

.modal-overlay.active {
  opacity: 1;
  visibility: visible;
}

.modal {
  background: var(--bg-card);
  border-radius: var(--radius);
  width: 100%;
  max-width: 520px;
  max-height: 85vh;
  border: 1px solid var(--border-color);
  display: flex;
  flex-direction: column;
}

.modal-header {
  padding: 20px 24px;
  border-bottom: 1px solid var(--border-color);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-title {
  font-size: 18px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 10px;
}

.modal-close {
  width: 32px;
  height: 32px;
  border-radius: var(--radius-sm);
  border: none;
  background: var(--bg-secondary);
  color: var(--text-secondary);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.modal-close:hover {
  background: var(--accent-danger-bg);
  color: var(--accent-danger);
}

.modal-body {
  padding: 24px;
  overflow-y: auto;
  flex: 1;
}

/* Comments List */
.comments-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-bottom: 20px;
}

.comment-item {
  background: var(--bg-secondary);
  border-radius: var(--radius-sm);
  padding: 16px;
  border-left: 3px solid var(--accent-mint);
}

.comment-item.important {
  border-left-color: var(--accent-warning);
}

.comment-item.urgent {
  border-left-color: var(--accent-danger);
}

.comment-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 8px;
}

.comment-author {
  font-weight: 500;
  font-size: 14px;
}

.comment-time {
  font-size: 12px;
  color: var(--text-muted);
}

.comment-text {
  color: var(--text-secondary);
  font-size: 14px;
  line-height: 1.5;
  white-space: pre-wrap;
}

.comment-actions {
  display: flex;
  gap: 8px;
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid var(--border-color);
}

.comment-action {
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  font-size: 12px;
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 4px 8px;
  border-radius: 4px;
}

.comment-action:hover {
  color: var(--text-primary);
  background: var(--bg-hover);
}

.comment-action.delete:hover {
  color: var(--accent-danger);
  background: var(--accent-danger-bg);
}

/* Comment Form */
.comment-form {
  display: flex;
  flex-direction: column;
  gap: 12px;
  padding-top: 20px;
  border-top: 1px solid var(--border-color);
}

.comment-form textarea {
  width: 100%;
  min-height: 80px;
  padding: 12px;
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-sm);
  color: var(--text-primary);
  font-family: inherit;
  font-size: 14px;
  resize: vertical;
}

.comment-form textarea:focus {
  outline: none;
  border-color: var(--accent-mint);
}

.priority-select {
  display: flex;
  gap: 8px;
}

.priority-btn {
  padding: 6px 12px;
  border: 1px solid var(--border-color);
  border-radius: 20px;
  background: var(--bg-secondary);
  color: var(--text-secondary);
  font-size: 12px;
  cursor: pointer;
  transition: all 0.2s;
}

.priority-btn.active,
.priority-btn:hover {
  border-color: var(--accent-mint);
  color: var(--accent-mint);
}

.priority-btn.important.active,
.priority-btn.important:hover {
  border-color: var(--accent-warning);
  color: var(--accent-warning);
}

.priority-btn.urgent.active,
.priority-btn.urgent:hover {
  border-color: var(--accent-danger);
  color: var(--accent-danger);
}

/* History Section */
.history-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.history-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 16px;
  background: var(--bg-secondary);
  border-radius: var(--radius-sm);
  border: 1px solid var(--border-color);
}

.history-info {
  display: flex;
  align-items: center;
  gap: 12px;
}

.history-icon {
  width: 40px;
  height: 40px;
  border-radius: var(--radius-sm);
  background: var(--accent-mint-bg);
  color: var(--accent-mint);
  display: flex;
  align-items: center;
  justify-content: center;
}

.history-details h4 {
  font-size: 14px;
  margin-bottom: 2px;
}

.history-details p {
  font-size: 12px;
  color: var(--text-muted);
}

/* Error Message */
.error-message {
  background: var(--accent-danger-bg);
  border: 1px solid var(--accent-danger);
  border-radius: var(--radius-sm);
  padding: 16px;
  margin-bottom: 20px;
  display: none;
}

.error-message.show {
  display: block;
}

.error-message h3 {
  color: var(--accent-danger);
  margin-bottom: 8px;
  font-size: 14px;
}

.error-message ul {
  padding-left: 20px;
  color: var(--text-secondary);
  font-size: 13px;
}

/* Toast */
.toast {
  position: fixed;
  bottom: 24px;
  right: 24px;
  background: var(--bg-card);
  color: var(--text-primary);
  padding: 14px 20px;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border-color);
  display: flex;
  align-items: center;
  gap: 10px;
  z-index: 2000;
  box-shadow: var(--shadow);
}

.toast.success {
  border-color: var(--accent-success);
}

.toast.success i {
  color: var(--accent-success);
}

/* Chart Container */
.chart-box {
  background: var(--bg-card);
  border-radius: var(--radius);
  padding: 24px;
  border: 1px solid var(--border-color);
  margin-bottom: 24px;
}

.chart-header {
  margin-bottom: 20px;
}

.chart-title {
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 8px;
}

/* Footer */
.footer {
  text-align: center;
  padding: 24px;
  color: var(--text-muted);
  font-size: 13px;
  border-top: 1px solid var(--border-color);
  margin-top: 40px;
}

/* Responsive */
@media (max-width: 768px) {
  .container {
    padding: 16px;
  }
  
  .summary-grid {
    grid-template-columns: 1fr;
  }
  
  .main-grid {
    grid-template-columns: 1fr;
  }
  
  .controls {
    flex-direction: column;
  }
  
  .search-box {
    min-width: 100%;
  }
}

/* Animations */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.section, .summary-card, .chart-box {
  animation: fadeIn 0.4s ease-out;
}
</style>
</head>
<body>
<div class="container">
  <!-- Header -->
  <div class="header">
    <div class="header-title">
      <i class="fas fa-chart-pie"></i>
      <span>Finance Dashboard</span>
    </div>
    <div class="header-actions">
      <button class="btn btn-secondary" onclick="resetAllData()">
        <i class="fas fa-trash"></i> Сбросить
      </button>
    </div>
  </div>

  <!-- Error Message -->
  <div class="error-message" id="errorMessage">
    <h3><i class="fas fa-exclamation-triangle"></i> Ошибка</h3>
    <ul id="errorList"></ul>
  </div>

  <!-- Summary Cards -->
  <div class="summary-grid" id="summaryGrid" style="display: none;">
    <div class="summary-card primary">
      <div class="summary-label">Общая выручка</div>
      <div class="summary-value" id="totalRevenue">0 ₽</div>
      <div class="summary-change">за весь период</div>
    </div>
    <div class="summary-card success">
      <div class="summary-label">Всего заказов</div>
      <div class="summary-value" id="totalOrders">0</div>
      <div class="summary-change">уникальных позиций</div>
    </div>
    <div class="summary-card mint">
      <div class="summary-label">Средний чек</div>
      <div class="summary-value" id="avgCheck">0 ₽</div>
      <div class="summary-change">на заказ</div>
    </div>
    <div class="summary-card">
      <div class="summary-label">Последнее обновление</div>
      <div class="summary-value" style="font-size: 16px;" id="lastUpdate">-</div>
    </div>
  </div>

  <!-- Upload Area -->
  <div class="upload-area" id="dropZone">
    <i class="fas fa-cloud-upload-alt"></i>
    <h3>Загрузить файл с заказами</h3>
    <p>Перетащите файл сюда или нажмите для выбора • Формат: .txt</p>
    <input type="file" id="fileInput" accept=".txt" hidden>
  </div>

  <!-- Main Grid -->
  <div class="main-grid" id="mainGrid" style="display: none;">
    <!-- Left Column -->
    <div>
      <!-- Budget Tracking -->
      <div class="section">
        <div class="section-header">
          <h2 class="section-title">Budget Tracking</h2>
        </div>
        <div class="budget-grid" id="budgetGrid">
          <!-- Budget cards will be inserted here -->
        </div>
      </div>

      <!-- Debt Details -->
      <div class="section">
        <div class="section-header">
          <h2 class="section-title">Debt Details</h2>
        </div>
        <div class="debt-grid" id="debtGrid">
          <!-- Debt cards will be inserted here -->
        </div>
      </div>

      <!-- History -->
      <div class="section" id="historySection" style="display: none;">
        <div class="section-header">
          <h2 class="section-title">History</h2>
        </div>
        <div class="history-list" id="historyList"></div>
      </div>
    </div>

    <!-- Right Column -->
    <div>
      <!-- Chart -->
      <div class="chart-box">
        <div class="chart-header">
          <div class="chart-title">Динамика выручки</div>
          <select class="filter-select" id="trendPeriod" style="margin-top: 12px;">
            <option value="all">Весь период</option>
            <option value="7">7 дней</option>
            <option value="30">30 дней</option>
          </select>
        </div>
        <canvas id="trendChart" style="max-height: 300px;"></canvas>
      </div>

      <!-- Expenses Table -->
      <div class="section">
        <div class="section-header">
          <h2 class="section-title">Expenses</h2>
        </div>
        <div class="controls">
          <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="Поиск...">
          </div>
          <select class="filter-select" id="typeFilter">
            <option value="">Все типы</option>
          </select>
          <select class="filter-select" id="dateFilter">
            <option value="">Все даты</option>
          </select>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>№</th>
                <th>Описание</th>
                <th>Тип</th>
                <th>Время</th>
                <th>Кв.м</th>
                <th>Пог.м</th>
                <th>Сумма</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div class="footer">
    Finance Dashboard © 2026 • Все данные обрабатываются локально
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Global data
let allFilesData = [];
let allOrders = [];
let orderComments = {};
let trendChartInstance = null;

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  loadComments();
  loadDataFromLocalStorage();
  setupEventListeners();
});

function setupEventListeners() {
  const dropZone = document.getElementById('dropZone');
  const fileInput = document.getElementById('fileInput');
  
  dropZone.addEventListener('click', () => fileInput.click());
  
  ['dragover', 'dragenter'].forEach(evt => 
    dropZone.addEventListener(evt, e => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    })
  );
  
  ['dragleave', 'drop'].forEach(evt => 
    dropZone.addEventListener(evt, e => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
    })
  );
  
  dropZone.addEventListener('drop', e => {
    if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
  });
  
  fileInput.addEventListener('change', e => {
    if (e.target.files[0]) handleFile(e.target.files[0]);
  });
  
  document.getElementById('searchInput').addEventListener('input', filterTable);
  document.getElementById('typeFilter').addEventListener('change', filterTable);
  document.getElementById('dateFilter').addEventListener('change', filterTable);
  document.getElementById('trendPeriod').addEventListener('change', renderTrendChart);
}

function handleFile(file) {
  if (!file.name.endsWith('.txt')) {
    showError('Пожалуйста, загрузите файл .txt');
    return;
  }
  
  const reader = new FileReader();
  reader.onload = e => {
    try {
      hideError();
      const fileData = parseOrderFile(e.target.result, file.name);
      
      if (allFilesData.some(f => f.fileName === file.name)) {
        showError('Файл уже загружен');
        return;
      }
      
      allFilesData.push(fileData);
      allOrders = allFilesData.flatMap(f => f.orders);
      
      updateUI();
      saveData();
    } catch (err) {
      showError('Ошибка: ' + err.message);
    }
  };
  reader.readAsText(file, 'utf-8');
}

function parseOrderFile(content, fileName) {
  let date = fileName.match(/(\d{2}\.\d{2}\.\d{4})/)?.[1] || new Date().toLocaleDateString('ru-RU');
  
  const orders = [];
  const sections = content.split('---');
  
  for (const section of sections) {
    const lines = section.trim().split('\n').filter(l => l.trim());
    if (lines.length < 2) continue;
    
    const numMatch = lines[0].match(/№(\d+)\.\s*(.+)/);
    if (!numMatch) continue;
    
    const order = {
      number: numMatch[1],
      code: numMatch[2].trim(),
      description: '',
      type: '',
      amount: 0,
      date,
      sourceFile: fileName,
      parameters: {}
    };
    
    if (lines[1]) {
      const descMatch = lines[1].match(/([^(]+)\s*(?:\(([^)]+)\))?/);
      if (descMatch) {
        order.description = descMatch[1].trim();
        order.type = descMatch[2]?.trim() || 'Без типа';
      }
    }
    
    for (let i = 2; i < lines.length; i++) {
      const line = lines[i].trim();
      
      // Parse amount
      if (line.startsWith('Сумма:')) {
        const sum = line.match(/[\d.,]+/)?.[0]?.replace(',', '.');
        if (sum) order.amount = parseFloat(sum);
      }
      
      // Parse volume/area measurements
      if (line.startsWith('Объем:')) {
        const vol = line.replace('Объем:', '').trim();
        const val = parseFloat(vol.match(/[\d.,]+/)?.[0]?.replace(',', '.'));
        
        if (vol.includes('м²') || vol.includes('кв.м') || vol.includes('кв м')) {
          order.parameters['sqm'] = val;
        } else if (vol.includes('пог.м') || vol.includes('пог м') || vol.includes('погонных')) {
          order.parameters['lm'] = val;
        } else if (vol.match(/час|ч\b|часа|часов/i)) {
          order.parameters['time'] = val;
        }
      }
      
      // Also check for explicit time parameter
      if (line.match(/время|час|ч\b/i) && !line.startsWith('Объем:')) {
        const val = parseFloat(line.match(/[\d.,]+/)?.[0]?.replace(',', '.'));
        if (val) order.parameters['time'] = val;
      }
    }
    
    if (order.description) orders.push(order);
  }
  
  const total = orders.reduce((s, o) => s + o.amount, 0);
  
  return { orders, total, date, fileName };
}

function updateUI() {
  updateSummary();
  renderBudgetTracking();
  renderDebtDetails();
  renderTrendChart();
  renderTable();
  updateHistory();
  
  document.getElementById('summaryGrid').style.display = 'grid';
  document.getElementById('mainGrid').style.display = 'grid';
  document.getElementById('historySection').style.display = 'block';
}

function updateSummary() {
  const revenue = allOrders.reduce((s, o) => s + o.amount, 0);
  const count = allOrders.length;
  const avg = count ? revenue / count : 0;
  
  document.getElementById('totalRevenue').textContent = formatCurrency(revenue);
  document.getElementById('totalOrders').textContent = count;
  document.getElementById('avgCheck').textContent = formatCurrency(avg);
  
  if (allFilesData.length) {
    const latest = allFilesData[allFilesData.length - 1]?.date || '-';
    document.getElementById('lastUpdate').textContent = latest;
  }
}

function renderBudgetTracking() {
  const grid = document.getElementById('budgetGrid');
  const types = {};
  
  allOrders.forEach(o => {
    types[o.type] = (types[o.type] || 0) + o.amount;
  });
  
  const total = Object.values(types).reduce((a, b) => a + b, 0);
  
  grid.innerHTML = Object.entries(types).map(([type, amount]) => {
    const pct = total > 0 ? (amount / total) * 100 : 0;
    let status = 'success';
    if (pct < 20) status = 'danger';
    else if (pct < 40) status = 'warning';
    
    return `
      <div class="budget-card ${status}">
        <div class="budget-name">${type}</div>
        <div class="budget-amount">${formatCurrency(amount)}</div>
        <span class="budget-status ${status}">${pct.toFixed(1)}%</span>
      </div>
    `;
  }).join('');
}

function renderDebtDetails() {
  const grid = document.getElementById('debtGrid');
  
  // Calculate totals from parameters
  const totalTime = allOrders.reduce((s, o) => s + (o.parameters.time || 0), 0);
  const totalSqm = allOrders.reduce((s, o) => s + (o.parameters.sqm || 0), 0);
  const totalLm = allOrders.reduce((s, o) => s + (o.parameters.lm || 0), 0);
  
  grid.innerHTML = `
    <div class="debt-card">
      <div class="debt-name"><i class="fas fa-clock"></i> Всего времени</div>
      <div class="debt-amount" style="color: var(--accent-primary);">${totalTime.toFixed(1)} ч</div>
      <div class="debt-info">Общее время работ</div>
    </div>
    <div class="debt-card">
      <div class="debt-name"><i class="fas fa-vector-square"></i> Всего площади</div>
      <div class="debt-amount" style="color: var(--accent-success);">${totalSqm.toFixed(2)} м²</div>
      <div class="debt-info">Квадратные метры</div>
    </div>
    <div class="debt-card">
      <div class="debt-name"><i class="fas fa-ruler-horizontal"></i> Всего длины</div>
      <div class="debt-amount" style="color: var(--accent-warning);">${totalLm.toFixed(2)} пог.м</div>
      <div class="debt-info">Погонные метры</div>
    </div>
  `;
}

function renderTrendChart() {
  const revenueByDate = {};
  allOrders.forEach(o => {
    revenueByDate[o.date] = (revenueByDate[o.date] || 0) + o.amount;
  });
  
  const dates = Object.keys(revenueByDate).sort();
  const values = dates.map(d => revenueByDate[d]);
  
  const ctx = document.getElementById('trendChart').getContext('2d');
  if (trendChartInstance) trendChartInstance.destroy();
  
  trendChartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels: dates,
      datasets: [{
        label: 'Выручка',
        data: values,
        borderColor: '#14b8a6',
        backgroundColor: 'rgba(20, 184, 166, 0.1)',
        borderWidth: 2,
        fill: true,
        tension: 0.4,
        pointBackgroundColor: '#14b8a6',
        pointRadius: 4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false }
      },
      scales: {
        y: {
          beginAtZero: true,
          grid: { color: '#2a2a2a' },
          ticks: { 
            color: '#a0a0a0',
            callback: v => formatCurrency(v)
          }
        },
        x: {
          grid: { display: false },
          ticks: { color: '#a0a0a0' }
        }
      }
    }
  });
}

function renderTable() {
  const tbody = document.getElementById('tableBody');
  tbody.innerHTML = '';
  
  allOrders.forEach(order => {
    const orderId = generateOrderId(order);
    const comments = orderComments[orderId] || [];
    
    // Format parameters with badges
    const timeBadge = order.parameters.time 
      ? `<span class="param-badge time"><i class="fas fa-clock"></i> ${order.parameters.time.toFixed(1)} ч</span>`
      : `<span class="param-badge empty">—</span>`;
    
    const sqmBadge = order.parameters.sqm 
      ? `<span class="param-badge sqm"><i class="fas fa-vector-square"></i> ${order.parameters.sqm.toFixed(2)} м²</span>`
      : `<span class="param-badge empty">—</span>`;
    
    const lmBadge = order.parameters.lm 
      ? `<span class="param-badge lm"><i class="fas fa-ruler-horizontal"></i> ${order.parameters.lm.toFixed(2)}</span>`
      : `<span class="param-badge empty">—</span>`;
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${order.number}</td>
      <td>${order.description}</td>
      <td><span style="color: var(--text-secondary);">${order.type}</span></td>
      <td>${timeBadge}</td>
      <td>${sqmBadge}</td>
      <td>${lmBadge}</td>
      <td class="amount-positive">${formatCurrency(order.amount)}</td>
      <td>
        <button class="comment-btn ${comments.length ? 'has-comments' : ''}" 
                onclick="openCommentsModal(${JSON.stringify(order).replace(/"/g, '&quot;')})">
          <i class="fas fa-comment"></i>
          ${comments.length ? `<span class="comment-badge">${comments.length}</span>` : ''}
        </button>
      </td>
    `;
    tbody.appendChild(tr);
  });
  
  // Update filters
  const types = [...new Set(allOrders.map(o => o.type))];
  const typeFilter = document.getElementById('typeFilter');
  typeFilter.innerHTML = '<option value="">Все типы</option>' + 
    types.map(t => `<option value="${t}">${t}</option>`).join('');
  
  const dates = [...new Set(allOrders.map(o => o.date))].sort();
  const dateFilter = document.getElementById('dateFilter');
  dateFilter.innerHTML = '<option value="">Все даты</option>' + 
    dates.map(d => `<option value="${d}">${d}</option>`).join('');
}

function filterTable() {
  const search = document.getElementById('searchInput').value.toLowerCase();
  const type = document.getElementById('typeFilter').value;
  const date = document.getElementById('dateFilter').value;
  
  document.querySelectorAll('#tableBody tr').forEach((row, i) => {
    const order = allOrders[i];
    const match = 
      (!search || order.description.toLowerCase().includes(search)) &&
      (!type || order.type === type) &&
      (!date || order.date === date);
    row.style.display = match ? '' : 'none';
  });
}

function updateHistory() {
  const list = document.getElementById('historyList');
  list.innerHTML = allFilesData.slice().reverse().map(file => `
    <div class="history-item">
      <div class="history-info">
        <div class="history-icon">
          <i class="fas fa-file-alt"></i>
        </div>
        <div class="history-details">
          <h4>${file.fileName}</h4>
          <p>${file.date} • ${formatCurrency(file.total)}</p>
        </div>
      </div>
      <button class="btn btn-secondary" onclick="removeFile('${file.fileName}')" style="padding: 6px 12px;">
        <i class="fas fa-times"></i>
      </button>
    </div>
  `).join('');
}

// Comments System
function loadComments() {
  try {
    const saved = localStorage.getItem('orderComments');
    if (saved) orderComments = JSON.parse(saved);
  } catch (e) { console.warn(e); }
}

function saveComments() {
  localStorage.setItem('orderComments', JSON.stringify(orderComments));
}

function generateOrderId(order) {
  return `${order.sourceFile}_${order.number}`.replace(/\s+/g, '_');
}

function addComment(order, text, priority = 'normal') {
  const orderId = generateOrderId(order);
  const comment = {
    id: Date.now().toString(36),
    text: text.trim(),
    priority,
    author: 'Вы',
    timestamp: new Date().toISOString()
  };
  
  if (!orderComments[orderId]) orderComments[orderId] = [];
  orderComments[orderId].push(comment);
  
  saveComments();
  return comment;
}

function deleteComment(order, commentId) {
  const orderId = generateOrderId(order);
  if (orderComments[orderId]) {
    orderComments[orderId] = orderComments[orderId].filter(c => c.id !== commentId);
    if (!orderComments[orderId].length) delete orderComments[orderId];
    saveComments();
    return true;
  }
  return false;
}

function formatCommentTime(iso) {
  const date = new Date(iso);
  const now = new Date();
  if (date.toDateString() === now.toDateString()) {
    return date.toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'});
  }
  return date.toLocaleDateString('ru-RU', {day: '2-digit', month:'short'});
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function showToast(msg) {
  const toast = document.createElement('div');
  toast.className = 'toast success';
  toast.innerHTML = `<i class="fas fa-check-circle"></i> ${msg}`;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

function openCommentsModal(order) {
  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.innerHTML = `
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">
          <i class="fas fa-comments"></i>
          Комментарии
        </div>
        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div style="margin-bottom: 16px; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
          <strong>Заказ №${order.number}</strong><br>
          <span style="color: var(--text-secondary); font-size: 13px;">${order.description}</span>
        </div>
        <div class="comments-list" id="commentsList"></div>
        <div class="comment-form">
          <textarea id="commentInput" placeholder="Добавить комментарий..."></textarea>
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div class="priority-select">
              <button class="priority-btn active" data-priority="normal">Обычный</button>
              <button class="priority-btn important" data-priority="important">Важно</button>
              <button class="priority-btn urgent" data-priority="urgent">Срочно</button>
            </div>
            <button class="btn btn-primary" id="commentSubmit">
              <i class="fas fa-paper-plane"></i> Отправить
            </button>
          </div>
        </div>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  const commentsList = modal.querySelector('#commentsList');
  const commentInput = modal.querySelector('#commentInput');
  const commentSubmit = modal.querySelector('#commentSubmit');
  const priorityBtns = modal.querySelectorAll('.priority-btn');
  
  let selectedPriority = 'normal';
  
  priorityBtns.forEach(btn => {
    btn.onclick = () => {
      priorityBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      selectedPriority = btn.dataset.priority;
    };
  });
  
  function render() {
    const comments = orderComments[generateOrderId(order)] || [];
    
    if (!comments.length) {
      commentsList.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 20px;">Нет комментариев</div>';
      return;
    }
    
    commentsList.innerHTML = comments.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)).map(c => `
      <div class="comment-item ${c.priority}">
        <div class="comment-header">
          <div class="comment-author">${c.author}</div>
          <div class="comment-time">${formatCommentTime(c.timestamp)}</div>
        </div>
        <div class="comment-text">${escapeHtml(c.text)}</div>
        <div class="comment-actions">
          <button class="comment-action" onclick="navigator.clipboard.writeText('${escapeHtml(c.text)}')">
            <i class="fas fa-copy"></i> Копировать
          </button>
          <button class="comment-action delete" onclick="deleteCommentAndRender(order, '${c.id}')">
            <i class="fas fa-trash"></i> Удалить
          </button>
        </div>
      </div>
    `).join('');
  }
  
  window.deleteCommentAndRender = (order, id) => {
    if (confirm('Удалить?')) {
      deleteComment(order, id);
      render();
      renderTable();
      showToast('Комментарий удалён');
    }
  };
  
  commentSubmit.onclick = () => {
    const text = commentInput.value.trim();
    if (!text) return;
    
    addComment(order, text, selectedPriority);
    commentInput.value = '';
    render();
    renderTable();
    showToast('Комментарий добавлен');
  };
  
  commentInput.addEventListener('keydown', e => {
    if (e.ctrlKey && e.key === 'Enter') commentSubmit.click();
  });
  
  setTimeout(() => modal.classList.add('active'), 10);
  render();
  commentInput.focus();
}

// Utilities
function formatCurrency(n) {
  return new Intl.NumberFormat('ru-RU', {style: 'currency', currency: 'RUB'}).format(n);
}

function showError(msg) {
  document.getElementById('errorList').innerHTML = `<li>${msg}</li>`;
  document.getElementById('errorMessage').classList.add('show');
  setTimeout(() => document.getElementById('errorMessage').classList.remove('show'), 5000);
}

function hideError() {
  document.getElementById('errorMessage').classList.remove('show');
}

function saveData() {
  localStorage.setItem('dashboardData', JSON.stringify({allFilesData, allOrders}));
}

function loadDataFromLocalStorage() {
  try {
    const saved = localStorage.getItem('dashboardData');
    if (saved) {
      const {allFilesData: files, allOrders: orders} = JSON.parse(saved);
      if (files?.length) {
        allFilesData = files;
        allOrders = orders || [];
        updateUI();
      }
    }
  } catch (e) { console.warn(e); }
}

function resetAllData() {
  if (confirm('Сбросить все данные?')) {
    allFilesData = [];
    allOrders = [];
    orderComments = {};
    localStorage.removeItem('dashboardData');
    localStorage.removeItem('orderComments');
    location.reload();
  }
}

function removeFile(fileName) {
  if (confirm('Удалить файл?')) {
    allFilesData = allFilesData.filter(f => f.fileName !== fileName);
    allOrders = allFilesData.flatMap(f => f.orders);
    
    Object.keys(orderComments).forEach(id => {
      if (id.includes(fileName)) delete orderComments[id];
    });
    saveComments();
    
    updateUI();
    saveData();
  }
}
</script>
</body>
</html>
