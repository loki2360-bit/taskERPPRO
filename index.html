<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É –¥–ª—è —Å—Ç–∏–ª–µ–π (Bootstrap) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; padding-top: 40px; }
        .container { max-width: 800px; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        #previewArea { 
            display: none; 
            margin-top: 20px; 
            border: 1px solid #ddd; 
            padding: 20px; 
            background: #fff;
            font-family: 'Courier New', Courier, monospace; /* –ú–æ–Ω–æ—à–∏—Ä–∏–Ω–Ω—ã–π —à—Ä–∏—Ñ—Ç –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã */
            white-space: pre-wrap; /* –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø—Ä–æ–±–µ–ª—ã –∏ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ */
        }
        @media print {
            body * { visibility: hidden; }
            #printSection, #printSection * { visibility: visible; }
            #printSection { position: absolute; left: 0; top: 0; width: 100%; }
        }
    </style>
</head>
<body>

<div class="container">
    <h2 class="mb-4 text-center">üì¶ –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤ –ø–æ –¥–∞—Ç–∞–º</h2>
    
    <div class="mb-3">
        <label for="fileInput" class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ TXT —Ñ–∞–π–ª—ã (–º–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ä–∞–∑—É):</label>
        <input class="form-control" type="file" id="fileInput" multiple accept=".txt">
        <div class="form-text">–§–∞–π–ª—ã –±—É–¥—É—Ç –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</div>
    </div>

    <button class="btn btn-primary w-100" onclick="processFiles()">–û–±—ä–µ–¥–∏–Ω–∏—Ç—å –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –∫ –ø–µ—á–∞—Ç–∏</button>

    <!-- –û–±–ª–∞—Å—Ç—å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏ –ø–µ—á–∞—Ç–∏ -->
    <div id="printSection" style="margin-top: 30px;">
        <div id="previewArea"></div>
    </div>
    
    <div id="controls" style="display:none; margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px;">
        <button class="btn btn-success me-2" onclick="window.print()">üñ®Ô∏è –ü–µ—á–∞—Ç—å / PDF</button>
        <button class="btn btn-outline-secondary" onclick="downloadTxt()">üíæ –°–∫–∞—á–∞—Ç—å –æ–±—â–∏–π TXT</button>
    </div>
</div>

<script>
    let finalContent = "";

    async function processFiles() {
        const fileInput = document.getElementById('fileInput');
        const files = Array.from(fileInput.files);

        if (files.length === 0) {
            alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ñ–∞–π–ª.");
            return;
        }

        // 1. –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã. 
        // –õ–æ–≥–∏–∫–∞: –ø—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å –¥–∞—Ç—É –∏–∑ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞. –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è - —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∏–º–µ–Ω–∏.
        files.sort((a, b) => {
            const dateA = extractDate(a.name);
            const dateB = extractDate(b.name);
            
            if (dateA && dateB) {
                return dateA - dateB;
            }
            return a.name.localeCompare(b.name);
        });

        finalContent = "";
        
        // 2. –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª—ã –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
        for (const file of files) {
            const text = await readFileAsText(file);
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å (–∏–º—è —Ñ–∞–π–ª–∞ –∏–ª–∏ –¥–∞—Ç—É), —á—Ç–æ–±—ã –±—ã–ª–æ –ø–æ–Ω—è—Ç–Ω–æ –≥–¥–µ –∫–∞–∫–æ–π –∑–∞–∫–∞–∑
            // –ú–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å —ç—Ç–æ—Ç –±–ª–æ–∫, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ "—á–∏—Å—Ç–æ–µ" —Å–∫–ª–µ–∏–≤–∞–Ω–∏–µ –±–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
            finalContent += `\n\n========================================\n`;
            finalContent += `–§–ê–ô–õ: ${file.name}\n`;
            finalContent += `========================================\n\n`;
            
            finalContent += text;
        }

        // 3. –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        const previewArea = document.getElementById('previewArea');
        previewArea.innerText = finalContent;
        previewArea.style.display = 'block';
        
        document.getElementById('controls').style.display = 'block';
        
        // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
        previewArea.scrollIntoView({ behavior: 'smooth' });
    }

    // –§—É–Ω–∫—Ü–∏—è —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞
    function readFileAsText(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsText(file);
        });
    }

    // –§—É–Ω–∫—Ü–∏—è –ø–æ–ø—ã—Ç–∫–∏ –Ω–∞–π—Ç–∏ –¥–∞—Ç—É –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ —Ñ–∞–π–ª–∞ (—Ñ–æ—Ä–º–∞—Ç YYYY-MM-DD –∏–ª–∏ DD.MM.YYYY)
    function extractDate(filename) {
        // –ò—â–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω —Ç–∏–ø–∞ 2023-10-05 –∏–ª–∏ 05.10.2023
        const patterns = [
            /(\d{4})-(\d{2})-(\d{2})/, // YYYY-MM-DD
            /(\d{2})\.(\d{2})\.(\d{4})/ // DD.MM.YYYY
        ];

        for (let pattern of patterns) {
            const match = filename.match(pattern);
            if (match) {
                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –Ω–∞–π–¥–µ–Ω–Ω–æ–µ –≤ –æ–±—ä–µ–∫—Ç Date –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
                if (pattern.source.includes('\\d{4}-')) {
                    return new Date(`${match[1]}-${match[2]}-${match[3]}`);
                } else {
                    return new Date(`${match[3]}-${match[2]}-${match[1]}`);
                }
            }
        }
        return null;
    }

    function downloadTxt() {
        const blob = new Blob([finalContent], { type: "text/plain;charset=utf-8" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "merged_orders.txt";
        link.click();
    }
</script>

</body>
</html>
