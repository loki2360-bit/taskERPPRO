<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Дашборд анализа заказов</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
:root {
--primary-color: #4e73df;
--success-color: #1cc88a;
--info-color: #36b9cc;
--warning-color: #f6c23e;
--danger-color: #e74a3b;
--light-color: #f8f9fc;
--dark-color: #5a5c69;
--card-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
--transition: all 0.2s;
}
* {
margin: 0;
padding: 0;
box-sizing: border-box;
}
body {
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
background-color: #f5f7fb;
color: #333;
line-height: 1.6;
min-height: 100vh;
}
.container {
max-width: 1400px;
margin: 0 auto;
padding: 20px;
}
header {
text-align: center;
margin-bottom: 30px;
padding: 20px;
background: white;
border-radius: 10px;
box-shadow: var(--card-shadow);
}
header h1 {
color: var(--primary-color);
margin-bottom: 10px;
display: flex;
justify-content: center;
align-items: center;
gap: 10px;
}
/* Зона загрузки */
.upload-area {
border: 2px dashed #ccc;
border-radius: 10px;
padding: 40px 20px;
text-align: center;
background-color: white;
cursor: pointer;
transition: var(--transition);
margin-bottom: 30px;
box-shadow: var(--card-shadow);
position: relative;
overflow: hidden;
}
.upload-area:hover, .upload-area.dragover {
border-color: var(--primary-color);
background-color: #f8f9fc;
}
.upload-area i {
font-size: 48px;
color: #ccc;
margin-bottom: 15px;
display: block;
}
.upload-area h2 {
font-size: 22px;
color: #555;
margin-bottom: 10px;
transition: var(--transition);
}
.upload-area p {
color: #888;
font-size: 16px;
}
.upload-area.dragover h2 {
color: var(--primary-color);
}
.upload-area input[type="file"] {
display: none;
}
/* Сводные карточки */
.summary-cards {
display: flex;
gap: 20px;
margin-bottom: 30px;
flex-wrap: wrap;
}
.card {
background: white;
border-radius: 10px;
box-shadow: var(--card-shadow);
padding: 20px;
flex: 1;
min-width: 250px;
transition: var(--transition);
display: flex;
}
.card:hover {
transform: translateY(-5px);
}
.card-icon {
width: 60px;
height: 60px;
border-radius: 10px;
display: flex;
align-items: center;
justify-content: center;
margin-right: 15px;
}
.total-revenue .card-icon {
background-color: rgba(78, 115, 223, 0.1);
color: var(--primary-color);
}
.total-orders .card-icon {
background-color: rgba(28, 200, 138, 0.1);
color: var(--success-color);
}
.avg-check .card-icon {
background-color: rgba(54, 185, 204, 0.1);
color: var(--info-color);
}
.last-update .card-icon {
background-color: rgba(246, 194, 62, 0.1);
color: var(--warning-color);
}
.card-icon i {
font-size: 28px;
}
.card-content h3 {
font-size: 16px;
color: var(--dark-color);
margin-bottom: 5px;
}
.value {
font-size: 24px;
font-weight: bold;
margin: 5px 0;
}
.subtitle {
font-size: 14px;
color: #888;
}
/* Графики */
.charts-container {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
gap: 25px;
margin-bottom: 30px;
}
.chart-box {
background: white;
border-radius: 10px;
box-shadow: var(--card-shadow);
padding: 20px;
height: 350px;
display: flex;
flex-direction: column;
min-width: 300px;
overflow: hidden;
}
.chart-box h2 {
margin-bottom: 15px;
color: var(--dark-color);
display: flex;
align-items: center;
}
.chart-box h2 i {
margin-right: 10px;
color: var(--primary-color);
}
.chart-container {
flex: 1;
position: relative;
}
/* Прогресс-бары */
.progress-group {
margin-bottom: 20px;
}
.progress-header {
display: flex;
justify-content: space-between;
margin-bottom: 5px;
}
.progress-title {
font-weight: 500;
}
.progress-value {
color: var(--dark-color);
font-weight: 500;
}
.progress {
height: 10px;
background-color: #e9ecef;
border-radius: 5px;
overflow: hidden;
}
.progress-fill {
height: 100%;
border-radius: 5px;
transition: width 0.3s;
}
/* История загрузок */
.history-section {
background: white;
border-radius: 10px;
box-shadow: var(--card-shadow);
padding: 20px;
margin-bottom: 30px;
}
.history-section h2 {
margin-bottom: 15px;
color: var(--dark-color);
display: flex;
align-items: center;
}
.history-list {
display: flex;
flex-direction: column;
gap: 10px;
}
.history-item {
display: flex;
align-items: center;
padding: 10px;
border-radius: 8px;
background-color: #f8f9fc;
transition: var(--transition);
}
.history-item:hover {
background-color: #e9ecef;
}
.history-item-icon {
width: 40px;
height: 40px;
border-radius: 8px;
background-color: rgba(78, 115, 223, 0.1);
color: var(--primary-color);
display: flex;
align-items: center;
justify-content: center;
margin-right: 15px;
flex-shrink: 0;
}
.history-item-details h4 {
margin-bottom: 3px;
font-size: 16px;
}
.history-item-details p {
color: #888;
font-size: 13px;
}
.history-item-actions {
margin-left: auto;
display: flex;
gap: 5px;
}
.btn-remove {
background: none;
border: none;
color: var(--danger-color);
cursor: pointer;
width: 30px;
height: 30px;
border-radius: 5px;
display: flex;
align-items: center;
justify-content: center;
transition: var(--transition);
}
.btn-remove:hover {
background-color: rgba(231, 74, 59, 0.1);
}
/* Таблица данных */
.data-table {
background: white;
border-radius: 10px;
box-shadow: var(--card-shadow);
padding: 20px;
margin-bottom: 30px;
}
.table-controls {
display: flex;
justify-content: space-between;
margin-bottom: 15px;
flex-wrap: wrap;
gap: 10px;
}
.search-box {
position: relative;
flex: 1;
max-width: 300px;
}
.search-box i {
position: absolute;
left: 10px;
top: 50%;
transform: translateY(-50%);
color: #888;
}
.search-box input {
width: 100%;
padding: 8px 10px 8px 30px;
border: 1px solid #ddd;
border-radius: 5px;
font-size: 14px;
}
.filters {
display: flex;
gap: 10px;
}
.filters select {
padding: 8px 10px;
border: 1px solid #ddd;
border-radius: 5px;
background-color: white;
}
table {
width: 100%;
border-collapse: collapse;
}
table thead {
background-color: #f8f9fc;
}
table th {
padding: 12px 15px;
text-align: left;
border-bottom: 2px solid #e9ecef;
font-weight: 600;
color: var(--dark-color);
}
table td {
padding: 12px 15px;
border-bottom: 1px solid #e9ecef;
}
table tr:hover {
background-color: #f8f9fc;
}
.amount-cell {
font-weight: bold;
color: var(--primary-color);
}
/* Футер */
footer {
text-align: center;
padding: 20px;
color: #888;
font-size: 14px;
margin-top: 20px;
}
/* Адаптивность */
@media (max-width: 1200px) {
.charts-container {
grid-template-columns: 1fr;
}
}
@media (max-width: 768px) {
.summary-cards {
flex-direction: column;
}
.table-controls {
flex-direction: column;
}
.search-box {
max-width: 100%;
}
}
/* Ошибки */
.error-message {
background: #fff5f5;
border-left: 4px solid #e74a3b;
padding: 15px;
border-radius: 4px;
margin: 15px 0;
display: none;
}
.error-message.show {
display: block;
animation: fadeIn 0.3s;
}
@keyframes fadeIn {
from { opacity: 0; transform: translateY(-10px); }
to { opacity: 1; transform: translateY(0); }
}
.error-message h3 {
color: #e74a3b;
margin-bottom: 5px;
}
.error-message ul {
padding-left: 20px;
}
.error-message li {
margin-bottom: 5px;
}
/* Заголовок дашборда */
.dashboard-header {
text-align: center;
margin-bottom: 30px;
padding: 20px;
background: white;
border-radius: 10px;
box-shadow: var(--card-shadow);
}
.dashboard-header h1 {
color: var(--primary-color);
margin-bottom: 10px;
display: flex;
justify-content: center;
align-items: center;
gap: 10px;
}
.dashboard-header p {
color: #6c757d;
max-width: 800px;
margin: 0 auto;
}
/* Кнопка сброса */
.reset-button {
background-color: var(--danger-color);
color: white;
border: none;
padding: 8px 15px;
border-radius: 5px;
cursor: pointer;
margin-left: 10px;
display: flex;
align-items: center;
gap: 5px;
transition: var(--transition);
}
.reset-button:hover {
background-color: #c13515;
}
</style>
</head>
<body>
<div class="container">
<header class="dashboard-header">
<h1><i class="fas fa-chart-line"></i> Дашборд анализа заказов</h1>
<p>Загрузите файл с заказами для визуализации данных. Все данные обрабатываются локально в вашем браузере.</p>
</header>
<div class="error-message" id="errorMessage">
<h3>Ошибка обработки файла</h3>
<ul id="errorList">
<li>Проверьте формат данных в файле</li>
<li>Файл должен соответствовать шаблону заказов</li>
</ul>
</div>
<div class="upload-area" id="dropZone">
<i class="fas fa-cloud-upload-alt"></i>
<h2>Перетащите сюда файл или нажмите для выбора</h2>
<p>Поддерживаемые форматы: .txt</p>
<input type="file" id="fileInput" accept=".txt" hidden>
</div>
<div class="summary-cards" id="summaryCards" style="display: none;">
<div class="card total-revenue">
<div class="card-icon">
<i class="fas fa-coins"></i>
</div>
<div class="card-content">
<h3>Общая выручка</h3>
<p class="value" id="totalRevenue">0 ₽</p>
<p class="subtitle">за выбранный период</p>
</div>
</div>
<div class="card total-orders">
<div class="card-icon">
<i class="fas fa-shopping-cart"></i>
</div>
<div class="card-content">
<h3>Всего заказов</h3>
<p class="value" id="totalOrders">0</p>
<p class="subtitle">уникальных позиций</p>
</div>
</div>
<div class="card avg-check">
<div class="card-icon">
<i class="fas fa-file-invoice-dollar"></i>
</div>
<div class="card-content">
<h3>Средний чек</h3>
<p class="value" id="avgCheck">0 ₽</p>
<p class="subtitle">на заказ</p>
</div>
</div>
<div class="card last-update">
<div class="card-icon">
<i class="fas fa-history"></i>
</div>
<div class="card-content">
<h3>Последнее обновление</h3>
<p class="value" id="lastUpdate">-</p>
<p class="subtitle">дата и время</p>
</div>
</div>
</div>
<div class="charts-container" id="chartsContainer" style="display: none;">
<div class="chart-box">
<h2><i class="fas fa-chart-bar"></i> Выручка по типам работ</h2>
<div class="chart-container">
<canvas id="typeChart"></canvas>
</div>
</div>
<div class="chart-box">
<h2><i class="fas fa-chart-pie"></i> Распределение заказов</h2>
<div class="chart-container">
<canvas id="ordersChart"></canvas>
</div>
</div>
<div class="chart-box">
<h2><i class="fas fa-chart-line"></i> Топ-5 самых дорогих заказов</h2>
<div class="chart-container">
<canvas id="topOrdersChart"></canvas>
</div>
</div>
<div class="chart-box">
<h2><i class="fas fa-tasks"></i> Прогресс выполнения</h2>
<div id="progressBars"></div>
</div>
</div>
<div class="history-section" id="historySection" style="display: none;">
<h2><i class="fas fa-history"></i> История загрузок</h2>
<div class="history-controls">
<button class="reset-button" id="resetAllButton">
<i class="fas fa-trash"></i> Сбросить все данные
</button>
</div>
<div class="history-list" id="historyList"></div>
</div>
<div class="data-table" id="dataTable" style="display: none;">
<h2><i class="fas fa-table"></i> Детализация заказов</h2>
<div class="table-controls">
<div class="search-box">
<i class="fas fa-search"></i>
<input type="text" id="searchInput" placeholder="Поиск по заказам...">
</div>
<div class="filters">
<select id="typeFilter">
<option value="">Все типы</option>
</select>
<select id="dateFilter">
<option value="">Все даты</option>
</select>
</div>
</div>
<table>
<thead>
<tr>
<th>№</th>
<th>Код</th>
<th>Описание</th>
<th>Тип</th>
<th>Дата</th>
<th>Файл</th>
<th>Сумма</th>
<th>Кв.м</th>
<th>Пог.м</th>
</tr>
</thead>
<tbody id="tableBody">
</tbody>
</table>
</div>
<footer>
<p>Дашборд анализа заказов &copy; 2026 | Все данные обрабатываются локально в вашем браузере</p>
</footer>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');
const chartsContainer = document.getElementById('chartsContainer');
const summaryCards = document.getElementById('summaryCards');
const historySection = document.getElementById('historySection');
const dataTable = document.getElementById('dataTable');
const errorMessage = document.getElementById('errorMessage');
const errorList = document.getElementById('errorList');
const resetAllButton = document.getElementById('resetAllButton');
// Глобальные переменные для хранения данных
let allFilesData = []; // Массив для хранения данных всех файлов
let allOrders = []; // Все заказы из всех файлов

// Функция для сохранения данных в localStorage
function saveDataToLocalStorage() {
  localStorage.setItem('dashboardData', JSON.stringify({
    allFilesData: allFilesData,
    allOrders: allOrders
  }));
}

// Функция для загрузки данных из localStorage
function loadDataFromLocalStorage() {
  const savedData = localStorage.getItem('dashboardData');
  if (savedData) {
    try {
      const { allFilesData: savedFilesData, allOrders: savedOrders } = JSON.parse(savedData);
      allFilesData = savedFilesData || [];
      allOrders = savedOrders || [];
      
      // Обновляем интерфейс
      updateSummaryCards();
      renderCharts();
      renderProgressBars();
      renderDataTable();
      updateHistoryList();
      
      // Показываем элементы
      chartsContainer.style.display = 'grid';
      summaryCards.style.display = 'flex';
      historySection.style.display = 'block';
      dataTable.style.display = 'block';
    } catch (e) {
      console.error('Ошибка при загрузке данных из localStorage:', e);
    }
  }
}

// Обработчики событий для зоны загрузки
dropZone.addEventListener('click', () => {
fileInput.click();
});
dropZone.addEventListener('dragover', (e) => {
e.preventDefault();
dropZone.classList.add('dragover');
});
dropZone.addEventListener('dragleave', () => {
dropZone.classList.remove('dragover');
});
dropZone.addEventListener('drop', (e) => {
e.preventDefault();
dropZone.classList.remove('dragover');
if (e.dataTransfer.files.length) {
handleFile(e.dataTransfer.files[0]);
}
});
fileInput.addEventListener('change', (e) => {
if (e.target.files.length) {
handleFile(e.target.files[0]);
}
});
// Обработчик сброса всех данных
resetAllButton.addEventListener('click', function() {
if (confirm('Вы действительно хотите сбросить все данные?')) {
allFilesData = [];
allOrders = [];
// Скрываем элементы интерфейса
chartsContainer.style.display = 'none';
summaryCards.style.display = 'none';
historySection.style.display = 'none';
dataTable.style.display = 'none';
// Обновляем историю
updateHistoryList();
// Сбрасываем таблицу
document.getElementById('tableBody').innerHTML = '';
// Удаляем данные из localStorage
localStorage.removeItem('dashboardData');
}
});
// Обработчик поиска и фильтров
document.getElementById('searchInput').addEventListener('input', filterTable);
document.getElementById('typeFilter').addEventListener('change', filterTable);
document.getElementById('dateFilter').addEventListener('change', filterTable);
// Обработка загруженного файла
function handleFile(file) {
if (!file.name.endsWith('.txt')) {
showError('Пожалуйста, загрузите текстовый файл (.txt)');
return;
}
const reader = new FileReader();
reader.onload = function(e) {
try {
// Сначала сбрасываем ошибки
hideError();
// Парсим файл
const fileData = parseOrderFile(e.target.result, file.name);
// Проверяем, не загружали ли мы уже этот файл
if (allFilesData.some(f => f.fileName === file.name)) {
showError('Этот файл уже был загружен ранее');
return;
}
// Добавляем в историю
addToHistory(file, fileData);
// Добавляем заказы к общему списку
allFilesData.push(fileData);
allOrders = allFilesData.flatMap(f => f.orders);
// Обновляем интерфейс с учетом всех данных
updateSummaryCards();
renderCharts();
renderProgressBars();
renderDataTable();
// Показываем скрытые элементы
chartsContainer.style.display = 'grid';
summaryCards.style.display = 'flex';
historySection.style.display = 'block';
dataTable.style.display = 'block';
// Сбрасываем выбор файла для возможности загрузки того же файла
fileInput.value = '';
// Сохраняем данные в localStorage
saveDataToLocalStorage();
} catch (error) {
console.error('Ошибка обработки файла:', error);
showError(`Не удалось обработать файл. Ошибка: ${error.message}`);
}
};
reader.onerror = function() {
showError('Ошибка чтения файла. Попробуйте загрузить другой файл.');
};
reader.readAsText(file, 'utf-8');
}
// Парсинг файла с заказами
function parseOrderFile(content, fileName) {
// Извлекаем дату из названия файла или содержимого
let dateMatch = fileName.match(/(\d{2}\.\d{2}\.\d{4})/);
let date = dateMatch ? dateMatch[1] : 'Неизвестно';
// Пытаемся найти дату в содержимом файла
const contentDateMatch = content.match(/ЗАКАЗЫ ЗА (\d{2}\.\d{2}\.\d{4})/);
if (contentDateMatch) {
date = contentDateMatch[1];
}
// Извлекаем экспортную дату и время
let exportDateTime = 'Неизвестно';
const exportMatch = content.match(/Экспорт: (\d{2}\.\d{2}\.\d{4}, \d{2}:\d{2}:\d{2})/);
if (exportMatch) {
exportDateTime = exportMatch[1];
}
// Разделяем заказы
const orderSections = content.split('---');
const orders = [];
// Обрабатываем каждый заказ
for (const section of orderSections) {
const lines = section.trim().split('\n');
// Пропускаем пустые секции
if (lines.length < 3) continue;
// Ищем номер и код заказа
const numMatch = lines[0].match(/№(\d+)\.\s*(.+)/);
if (!numMatch) continue;
const order = {
number: numMatch[1],
code: numMatch[2].trim().replace(/\s+/g, ' '),
description: '',
type: '',
amount: 0,
date: date,
sourceFile: fileName,
parameters: {}
};
// Ищем описание и тип
if (lines.length > 1) {
const descMatch = lines[1].trim().match(/([^\(]+)\s*\(([^\)]+)\)/);
if (descMatch) {
order.description = descMatch[1].trim();
order.type = descMatch[2].trim();
} else {
// Если нет скобок, берем всю строку как описание
order.description = lines[1].trim();
}
}
// Обрабатываем параметры
for (let i = 2; i < lines.length; i++) {
const line = lines[i].trim();
if (!line) continue;
// Парсим параметры (Длина, Ширина и т.д.)
const paramMatch = line.match(/([^:]+):\s*([^\s]+)/);
if (paramMatch) {
const paramName = paramMatch[1].trim();
let paramValue = paramMatch[2].trim();
// Сохраняем параметр
order.parameters[paramName] = paramValue;
// Обработка квадратных и погонных метров
if (paramName === 'Кв.м' || paramName === 'Пог.м') {
order.parameters[paramName] = parseFloat(paramValue.replace(',', '.'));
}
// Если это сумма, извлекаем значение
if (paramName === 'Сумма' || line.includes('Сумма')) {
const sumMatch = line.match(/Сумма:\s*([\d.,]+)/);
if (sumMatch) {
order.amount = parseFloat(sumMatch[1].replace(',', '.'));
}
}
}

// ДОПОЛНИТЕЛЬНАЯ ОБРАБОТКА ДЛЯ КВ.М И ПОГ.М
// Ищем значения в различных форматах
if (!order.parameters['Кв.м']) {
// Формат "10,5 кв.м"
const sqmMatch1 = line.match(/(\d+[\.,]?\d*)\s*кв\.м/i);
// Формат "10,5кв.м" (без пробела)
const sqmMatch2 = line.match(/(\d+[\.,]?\d*)кв\.м/i);
// Формат "кв.м: 10,5"
const sqmMatch3 = line.match(/кв\.м\s*:\s*(\d+[\.,]?\d*)/i);
// Формат "10,5 кв.м (пог.м: 5,2)"
const sqmMatch4 = line.match(/(\d+[\.,]?\d*)\s*кв\.м\s*\(?пог\.м\s*:\s*\d+[\.,]?\d*\)?/i);
// Формат "кв.м: 10,5 пог.м: 5,2"
const sqmMatch5 = line.match(/кв\.м\s*:\s*(\d+[\.,]?\d*)\s*пог\.м\s*:\s*\d+[\.,]?\d*/i);
// Формат "кв.м 10,5"
const sqmMatch6 = line.match(/кв\.м\s+(\d+[\.,]?\d*)/i);
// Формат "10.5 кв.м"
const sqmMatch7 = line.match(/(\d+[\.,]?\d*)\s*кв\.м/i);

const matches = [sqmMatch1, sqmMatch2, sqmMatch3, sqmMatch4, sqmMatch5, sqmMatch6, sqmMatch7];
for (const match of matches) {
if (match && match[1]) {
order.parameters['Кв.м'] = parseFloat(match[1].replace(',', '.'));
break;
}
}
}

if (!order.parameters['Пог.м']) {
// Формат "10,5 пог.м"
const lmMatch1 = line.match(/(\d+[\.,]?\d*)\s*пог\.м/i);
// Формат "10,5пог.м" (без пробела)
const lmMatch2 = line.match(/(\d+[\.,]?\d*)пог\.м/i);
// Формат "пог.м: 10,5"
const lmMatch3 = line.match(/пог\.м\s*:\s*(\d+[\.,]?\d*)/i);
// Формат "10,5 пог.м (кв.м: 5,2)"
const lmMatch4 = line.match(/(\d+[\.,]?\d*)\s*пог\.м\s*\(?кв\.м\s*:\s*\d+[\.,]?\d*\)?/i);
// Формат "пог.м: 10,5 кв.м: 5,2"
const lmMatch5 = line.match(/пог\.м\s*:\s*(\d+[\.,]?\d*)\s*кв\.м\s*:\s*\d+[\.,]?\d*/i);
// Формат "пог.м 10,5"
const lmMatch6 = line.match(/пог\.м\s+(\d+[\.,]?\d*)/i);
// Формат "10.5 пог.м"
const lmMatch7 = line.match(/(\d+[\.,]?\d*)\s*пог\.м/i);

const matches = [lmMatch1, lmMatch2, lmMatch3, lmMatch4, lmMatch5, lmMatch6, lmMatch7];
for (const match of matches) {
if (match && match[1]) {
order.parameters['Пог.м'] = parseFloat(match[1].replace(',', '.'));
break;
}
}
}
}
// Если сумма не найдена, ищем ее в последней строке
if (order.amount === 0) {
const lastLine = lines[lines.length - 1].trim();
const sumMatch = lastLine.match(/Сумма:\s*([\d.,]+)/);
if (sumMatch) {
order.amount = parseFloat(sumMatch[1].replace(',', '.'));
}
}
orders.push(order);
}
// Извлекаем итоговую сумму
let total = 0;
const totalMatch = content.match(/ИТОГО:\s*([\d.,]+)/);
if (totalMatch) {
total = parseFloat(totalMatch[1].replace(',', '.'));
} else {
// Если ИТОГО не найдено, считаем сумму вручную
total = orders.reduce((sum, order) => sum + order.amount, 0);
}
return {
orders: orders,
total: total,
date: date,
exportDateTime: exportDateTime,
fileName: fileName
};
}
// Обновление сводных карточек (с учетом всех файлов)
function updateSummaryCards() {
// Суммируем данные по всем файлам
const totalRevenue = allOrders.reduce((sum, order) => sum + order.amount, 0);
const totalOrders = allOrders.length;
const avgCheck = totalRevenue / totalOrders;
document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);
document.getElementById('totalOrders').textContent = totalOrders;
document.getElementById('avgCheck').textContent = formatCurrency(avgCheck);
// Берем последнее время обновления
if (allFilesData.length > 0) {
const latestUpdate = allFilesData
.map(f => f.exportDateTime)
.sort()
.pop();
document.getElementById('lastUpdate').textContent = latestUpdate;
}
}
// Построение графиков (с учетом всех файлов)
function renderCharts() {
// 1. Выручка по типам работ
renderTypeChart();
// 2. Распределение заказов
renderOrdersChart();
// 3. Топ-5 самых дорогих заказов
renderTopOrdersChart();
}
// Выручка по типам работ
function renderTypeChart() {
const typeRevenue = {};
let totalRevenue = 0;
// Собираем данные по типам из всех заказов
allOrders.forEach(order => {
if (!typeRevenue[order.type]) {
typeRevenue[order.type] = 0;
}
typeRevenue[order.type] += order.amount;
totalRevenue += order.amount;
});
// Подготовка данных для Chart.js
const labels = Object.keys(typeRevenue);
const values = Object.values(typeRevenue);
// Создаем или обновляем график
const ctx = document.getElementById('typeChart').getContext('2d');
// Удаляем предыдущий график, если он существует
if (Chart.getChart(ctx)) {
Chart.getChart(ctx).destroy();
}
new Chart(ctx, {
type: 'bar',
data: {
labels: labels,
datasets: [{
label: 'Выручка (₽)',
data: values,
backgroundColor: labels.map(() => getRandomColor(0.7)),
borderColor: labels.map(() => getRandomColor(1)),
borderWidth: 1
}]
},
options: {
responsive: true,
maintainAspectRatio: false,
plugins: {
legend: {
display: false
},
tooltip: {
callbacks: {
label: function(context) {
const value = context.parsed.y;
const percentage = ((value / totalRevenue) * 100).toFixed(1);
return `${formatCurrency(value)} (${percentage}%)`;
}
}
}
},
scales: {
y: {
beginAtZero: true,
ticks: {
callback: function(value) {
return formatCurrency(value);
}
}
}
}
}
});
}
// Распределение заказов
function renderOrdersChart() {
const typeCount = {};
// Собираем количество заказов по типам из всех заказов
allOrders.forEach(order => {
if (!typeCount[order.type]) {
typeCount[order.type] = 0;
}
typeCount[order.type]++;
});
// Подготовка данных для Chart.js
const labels = Object.keys(typeCount);
const values = Object.values(typeCount);
// Создаем или обновляем график
const ctx = document.getElementById('ordersChart').getContext('2d');
// Удаляем предыдущий график, если он существует
if (Chart.getChart(ctx)) {
Chart.getChart(ctx).destroy();
}
new Chart(ctx, {
type: 'doughnut',
data: {
labels: labels,
datasets: [{
data: values,
backgroundColor: labels.map(() => getRandomColor(0.7)),
borderColor: '#fff',
borderWidth: 1
}]
},
options: {
responsive: true,
maintainAspectRatio: false,
plugins: {
legend: {
position: 'right'
},
tooltip: {
callbacks: {
label: function(context) {
const value = context.parsed;
const total = context.dataset.data.reduce((a, b) => a + b, 0);
const percentage = ((value / total) * 100).toFixed(1);
return `${context.label}: ${value} заказов (${percentage}%)`;
}
}
}
}
}
});
// Обновляем фильтр типов в таблице
const typeFilter = document.getElementById('typeFilter');
typeFilter.innerHTML = '<option value="">Все типы</option>';
labels.forEach(type => {
const option = document.createElement('option');
option.value = type;
option.textContent = type;
typeFilter.appendChild(option);
});
}
// Топ-5 самых дорогих заказов
function renderTopOrdersChart() {
// Сортируем заказы по сумме в убывающем порядке и берем первые 5
const topOrders = [...allOrders]
.sort((a, b) => b.amount - a.amount)
.slice(0, 5);
const labels = topOrders.map(order => {
// Укорачиваем описание, если оно слишком длинное
let desc = order.description;
if (desc.length > 20) {
return desc.substring(0, 20) + '...';
}
return desc;
});
const values = topOrders.map(order => order.amount);
const codes = topOrders.map(order => order.code);
// Создаем или обновляем график
const ctx = document.getElementById('topOrdersChart').getContext('2d');
// Удаляем предыдущий график, если он существует
if (Chart.getChart(ctx)) {
Chart.getChart(ctx).destroy();
}
new Chart(ctx, {
type: 'bar',
data: {
labels: labels,
datasets: [{
label: 'Сумма (₽)',
data: values,
backgroundColor: labels.map(() => getRandomColor(0.7)),
borderColor: labels.map(() => getRandomColor(1)),
borderWidth: 1
}]
},
options: {
indexAxis: 'y',
responsive: true,
maintainAspectRatio: false,
plugins: {
legend: {
display: false
},
tooltip: {
callbacks: {
title: function(tooltipItems) {
// Ищем полное описание для этого элемента
const label = tooltipItems[0].label;
const index = labels.indexOf(label);
return topOrders[index].description;
},
label: function(context) {
const orderIndex = context.dataIndex;
return [
`Код: ${codes[orderIndex]}`,
`Сумма: ${formatCurrency(context.parsed.x)}`
];
}
}
}
},
scales: {
x: {
beginAtZero: true,
ticks: {
callback: function(value) {
return formatCurrency(value);
}
}
}
}
}
});
}
// Прогресс выполнения
function renderProgressBars() {
const progressBarContainer = document.getElementById('progressBars');
progressBarContainer.innerHTML = '';
// Суммируем данные по всем файлам
const totalRevenue = allOrders.reduce((sum, order) => sum + order.amount, 0);
const totalOrders = allOrders.length;
// Определяем целевые значения для прогресса
// Например, можно установить цели на день/неделю
const dailyTarget = 3000; // Целевая выручка за день
const ordersTarget = 15;  // Целевое количество заказов за день
// Прогресс по выручке
createProgressBar(
progressBarContainer,
'Выручка за период',
totalRevenue,
dailyTarget * allFilesData.length,
'₽',
'#4e73df'
);
// Прогресс по количеству заказов
createProgressBar(
progressBarContainer,
'Количество заказов',
totalOrders,
ordersTarget * allFilesData.length,
'',
'#1cc88a'
);
// Прогресс по типам работ (берем самый популярный тип)
const typeCount = {};
allOrders.forEach(order => {
typeCount[order.type] = (typeCount[order.type] || 0) + 1;
});
const mostCommonType = Object.keys(typeCount).reduce((a, b) =>
typeCount[a] > typeCount[b] ? a : b
);
createProgressBar(
progressBarContainer,
`Заказы типа "${mostCommonType}"`,
typeCount[mostCommonType],
Math.max(ordersTarget * 0.6 * allFilesData.length, typeCount[mostCommonType] + 2),
'',
'#36b9cc'
);
}
// Создание одного прогресс-бара
function createProgressBar(container, title, currentValue, targetValue, unit, color) {
const progressGroup = document.createElement('div');
progressGroup.className = 'progress-group';
const header = document.createElement('div');
header.className = 'progress-header';
header.innerHTML = `
<span class="progress-title">${title}</span>
<span class="progress-value">${formatNumber(currentValue)}${unit} / ${formatNumber(targetValue)}${unit}</span>
`;
const progressBar = document.createElement('div');
progressBar.className = 'progress';
const progressFill = document.createElement('div');
progressFill.className = 'progress-fill';
progressFill.style.width = `${Math.min((currentValue / targetValue) * 100, 100)}%`;
progressFill.style.backgroundColor = color;
progressBar.appendChild(progressFill);
progressGroup.appendChild(header);
progressGroup.appendChild(progressBar);
container.appendChild(progressGroup);
}
// Детализация заказов
function renderDataTable() {
const tableBody = document.getElementById('tableBody');
tableBody.innerHTML = '';
// Заполняем таблицу
allOrders.forEach(order => {
const row = document.createElement('tr');
row.innerHTML = `
<td>${order.number}</td>
<td>${order.code}</td>
<td title="${order.description}">${order.description.substring(0, 30)}${order.description.length > 30 ? '...' : ''}</td>
<td>${order.type}</td>
<td>${order.date}</td>
<td title="${order.sourceFile}">${order.sourceFile.substring(0, 15)}${order.sourceFile.length > 15 ? '...' : ''}</td>
<td class="amount-cell">${formatCurrency(order.amount)}</td>
<td>${order.parameters['Кв.м'] !== undefined ? parseFloat(order.parameters['Кв.м']).toFixed(2) : '-'}</td>
<td>${order.parameters['Пог.м'] !== undefined ? parseFloat(order.parameters['Пог.м']).toFixed(2) : '-'}</td>
`;
tableBody.appendChild(row);
});
}
// Фильтрация таблицы
function filterTable() {
const searchText = document.getElementById('searchInput').value.toLowerCase();
const typeFilter = document.getElementById('typeFilter').value;
const dateFilter = document.getElementById('dateFilter').value;
const rows = document.querySelectorAll('#tableBody tr');
rows.forEach(row => {
const description = row.cells[2].textContent.toLowerCase();
const type = row.cells[3].textContent;
const date = row.cells[4].textContent;
const matchesSearch = searchText === '' || description.includes(searchText);
const matchesType = typeFilter === '' || type === typeFilter;
const matchesDate = dateFilter === '' || date === dateFilter;
row.style.display = (matchesSearch && matchesType && matchesDate) ? '' : 'none';
});
}
// Добавление в историю загрузок
function addToHistory(file, fileData) {
const historyItem = {
id: Date.now(),
name: file.name,
date: new Date().toLocaleString(),
size: formatFileSize(file.size),
fileData: fileData
};
// Добавляем в начало списка
updateHistoryList();
}
// Обновление списка истории
function updateHistoryList() {
const historyList = document.getElementById('historyList');
historyList.innerHTML = '';
// Сортируем по времени добавления (новые сверху)
const sortedFiles = [...allFilesData].reverse();
sortedFiles.forEach(fileData => {
const historyItem = document.createElement('div');
historyItem.className = 'history-item';
historyItem.innerHTML = `
<div class="history-item-icon">
<i class="fas fa-file-alt"></i>
</div>
<div class="history-item-details">
<h4>${fileData.fileName}</h4>
<p><i class="far fa-clock"></i> ${fileData.exportDateTime} &bull; <i class="fas fa-coins"></i> ${formatCurrency(fileData.total)}</p>
</div>
<div class="history-item-actions">
<button class="btn-remove" data-filename="${fileData.fileName}">
<i class="fas fa-trash"></i>
</button>
</div>
`;
historyList.appendChild(historyItem);
});
// Добавляем обработчики удаления
document.querySelectorAll('.btn-remove').forEach(button => {
button.addEventListener('click', function() {
const fileName = this.getAttribute('data-filename');
removeFromHistory(fileName);
});
});
}
// Удаление из истории
function removeFromHistory(fileName) {
// Фильтруем файлы, оставляя только те, у которых имя не совпадает с указанным
allFilesData = allFilesData.filter(file => file.fileName !== fileName);
// Обновляем общий список заказов
allOrders = allFilesData.flatMap(f => f.orders);
// Обновляем интерфейс
updateSummaryCards();
renderCharts();
renderProgressBars();
renderDataTable();
// Обновляем историю
updateHistoryList();
// Если удаляем все данные, скрываем график
if (allFilesData.length === 0) {
chartsContainer.style.display = 'none';
summaryCards.style.display = 'none';
historySection.style.display = 'none';
dataTable.style.display = 'none';
}
// Сохраняем данные в localStorage
saveDataToLocalStorage();
}
// Вспомогательные функции
function formatCurrency(amount) {
return new Intl.NumberFormat('ru-RU', {
style: 'currency',
currency: 'RUB',
minimumFractionDigits: 2
}).format(amount).replace('RUB', '₽');
}
function formatNumber(number) {
return new Intl.NumberFormat('ru-RU').format(number);
}
function formatFileSize(bytes) {
if (bytes === 0) return '0 Б';
const k = 1024;
const sizes = ['Б', 'КБ', 'МБ', 'ГБ'];
const i = Math.floor(Math.log(bytes) / Math.log(k));
return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}
function getRandomColor(opacity = 1) {
const r = Math.floor(Math.random() * 256);
const g = Math.floor(Math.random() * 256);
const b = Math.floor(Math.random() * 256);
return `rgba(${r}, ${g}, ${b}, ${opacity})`;
}
// Обработка ошибок
function showError(message) {
errorList.innerHTML = `<li>${message}</li>`;
errorMessage.classList.add('show');
// Скрываем через 5 секунд
setTimeout(() => {
errorMessage.classList.remove('show');
}, 5000);
}
function hideError() {
errorMessage.classList.remove('show');
}

// Загружаем данные из localStorage при инициализации
loadDataFromLocalStorage();
});
</script>
</body>
</html>
