<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { 
            background-color: #f8f9fa; 
            padding-top: 40px; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .container { 
            max-width: 1400px; 
            background: white; 
            padding: 30px; 
            border-radius: 10px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
        }
        .dashboard {
            display: none;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            color: white;
        }
        .dashboard.show {
            display: block;
        }
        .stat-card {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 15px;
            backdrop-filter: blur(10px);
        }
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }
        .date-stats {
            background: rgba(255,255,255,0.1);
            padding: 10px 15px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 13px;
        }
        .operation-tag {
            display: inline-block;
            background: rgba(255,255,255,0.3);
            padding: 3px 10px;
            border-radius: 12px;
            margin: 2px;
            font-size: 11px;
        }
        #previewArea { 
            display: none; 
            margin-top: 20px; 
            padding: 10mm;
            background: #fff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.3;
            font-size: 10px;
        }
        
        .date-section {
            margin-bottom: 8px;
            page-break-inside: avoid;
        }
        .date-header { 
            color: #d63384; 
            font-weight: bold;
            font-size: 11px;
            margin: 0 0 4px 0;
            padding: 2px 6px;
            background-color: #f8d7da;
            border-radius: 2px;
            display: inline-block;
        }
        .orders-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 4px;
        }
        .order-item {
            background-color: #f8f9fa;
            padding: 4px 5px;
            border-radius: 2px;
            border-left: 2px solid #0d6efd;
            page-break-inside: avoid;
        }
        .order-number { 
            color: #0d6efd; 
            font-weight: bold;
            font-size: 9px;
            margin-bottom: 2px;
        }
        .item-line {
            margin: 1px 0;
            padding-left: 5px;
            color: #495057;
            font-size: 9px;
        }
        .volume-line {
            margin: 2px 0 0 5px;
            color: #6f42c1;
            font-weight: bold;
            font-size: 9px;
        }
        .quantity { 
            color: #fd7e14;
            font-weight: bold;
        }
        
        @media print {
            @page {
                size: A4;
                margin: 5mm;
            }
            body { 
                background: white;
                padding: 0;
            }
            body * { 
                visibility: hidden; 
            }
            #printSection, #printSection * { 
                visibility: visible; 
            }
            #printSection { 
                position: absolute; 
                left: 0; 
                top: 0; 
                width: 100%;
                padding: 5mm;
            }
            #previewArea {
                display: block !important;
                padding: 0;
            }
            .date-header { 
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact;
            }
            .order-item {
                break-inside: avoid;
            }
            .date-section {
                break-inside: avoid;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <h2 class="mb-4 text-center">üì¶ –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤ –ø–æ –¥–∞—Ç–∞–º</h2>
    
    <div class="mb-3">
        <label for="fileInput" class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ TXT —Ñ–∞–π–ª—ã (–º–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ä–∞–∑—É):</label>
        <input class="form-control" type="file" id="fileInput" multiple accept=".txt">
        <div class="form-text">–§–∞–π–ª—ã –±—É–¥—É—Ç –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</div>
    </div>

    <button class="btn btn-primary w-100" onclick="processFiles()">üìä –û–±—ä–µ–¥–∏–Ω–∏—Ç—å –∏ –ø–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard">
        <h4 class="mb-3">üìà –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h4>
        <div class="row">
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-value" id="totalOrders">0</div>
                    <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-value" id="totalM2">0</div>
                    <div class="stat-label">–ö–≤–∞–¥—Ä–∞—Ç–æ–≤ (–º¬≤)</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-value" id="totalLM">0</div>
                    <div class="stat-label">–ü–æ–≥–æ–Ω–Ω—ã—Ö –º–µ—Ç—Ä–æ–≤</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-value" id="totalHours">0</div>
                    <div class="stat-label">–ß–∞—Å–æ–≤ —Ä–∞–±–æ—Ç—ã</div>
                </div>
            </div>
        </div>
        
        <div class="row mt-3">
            <div class="col-md-6">
                <div class="stat-card">
                    <div class="stat-label mb-2">üîß –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</div>
                    <div id="topOperations"></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="stat-card">
                    <div class="stat-label mb-2">üìÖ –ü–æ –¥–∞—Ç–∞–º</div>
                    <div id="dateStats"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="printSection" style="margin-top: 30px;">
        <div id="previewArea"></div>
    </div>
    
    <div id="controls" style="display:none; margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px;">
        <button class="btn btn-success me-2" onclick="window.print()">üñ®Ô∏è –ü–µ—á–∞—Ç—å / PDF</button>
        <button class="btn btn-outline-secondary" onclick="downloadTxt()">üíæ –°–∫–∞—á–∞—Ç—å TXT</button>
    </div>
</div>

<script>
    let finalContent = "";
    let finalHtml = "";
    let globalStats = {
        totalOrders: 0,
        totalM2: 0,
        totalLM: 0,
        totalHours: 0,
        operations: {},
        dates: {}
    };

    async function processFiles() {
        const fileInput = document.getElementById('fileInput');
        const files = Array.from(fileInput.files);

        if (files.length === 0) {
            alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ñ–∞–π–ª.");
            return;
        }

        files.sort((a, b) => {
            const dateA = extractDate(a.name);
            const dateB = extractDate(b.name);
            
            if (dateA && dateB) {
                return dateA - dateB;
            }
            return a.name.localeCompare(b.name);
        });

        finalContent = "";
        finalHtml = "";
        globalStats = {
            totalOrders: 0,
            totalM2: 0,
            totalLM: 0,
            totalHours: 0,
            operations: {},
            dates: {}
        };
        
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const text = await readFileAsText(file);
            
            const dateStr = formatDateFromFile(file.name);
            
            if (i > 0) {
                finalContent += '\n';
            }
            
            const lines = text.split('\n');
            let orders = [];
            let currentOrder = null;
            let orderTotals = { m2: 0, lm: 0, hours: 0 };
            let dateStats = { m2: 0, lm: 0, hours: 0, orders: 0, operations: {} };
            
            for (let j = 0; j < lines.length; j++) {
                const trimmed = lines[j].trim();
                
                if (trimmed.length === 0) continue;
                if (trimmed.toLowerCase().includes('–∑–∞–∫–∞–∑—ã –∑–∞')) continue;
                if (/^[‚ïê=-]+$/.test(trimmed)) continue;
                if (trimmed.toLowerCase().includes('—Å—É–º–º–∞:')) continue;
                if (trimmed.toLowerCase().includes('–∏—Ç–æ–≥–æ:')) continue;
                if (trimmed.toLowerCase().includes('–∏—Ç–æ–≥–æ –ø–æ –∑–∞–∫–∞–∑—É')) continue;
                if (trimmed.toLowerCase().includes('–æ–±—â–∞—è —Å—É–º–º–∞ –∑–∞ –¥–µ–Ω—å')) continue;
                if (trimmed.toLowerCase().includes('—ç–∫—Å–ø–æ—Ä—Ç:')) continue;
                if (trimmed.includes('undefined') || trimmed.includes('NaN')) continue;
                
                // Extract operation type
                extractOperation(trimmed, dateStats.operations);
                
                if (/^‚Ññ\s*\d/i.test(trimmed)) {
                    if (currentOrder) {
                        currentOrder.totals = {...orderTotals};
                        orders.push(currentOrder);
                        dateStats.orders++;
                        dateStats.m2 += orderTotals.m2;
                        dateStats.lm += orderTotals.lm;
                        dateStats.hours += orderTotals.hours;
                    }
                    const orderNumber = trimmed.match(/‚Ññ\s*[\d-]+/i)[0];
                    currentOrder = { number: orderNumber, lines: [] };
                    orderTotals = { m2: 0, lm: 0, hours: 0 };
                }
                
                if (currentOrder) {
                    extractVolumes(trimmed, orderTotals);
                    let processedLine = removePrices(trimmed);
                    if (processedLine.length > 0 && !processedLine.match(/^‚Ññ/i)) {
                        currentOrder.lines.push(processedLine);
                    }
                }
            }
            
            if (currentOrder) {
                currentOrder.totals = {...orderTotals};
                orders.push(currentOrder);
                dateStats.orders++;
                dateStats.m2 += orderTotals.m2;
                dateStats.lm += orderTotals.lm;
                dateStats.hours += orderTotals.hours;
            }
            
            // Save date stats
            globalStats.dates[dateStr] = dateStats;
            globalStats.totalOrders += dateStats.orders;
            globalStats.totalM2 += dateStats.m2;
            globalStats.totalLM += dateStats.lm;
            globalStats.totalHours += dateStats.hours;
            
            // Merge operations
            for (let op in dateStats.operations) {
                if (!globalStats.operations[op]) {
                    globalStats.operations[op] = 0;
                }
                globalStats.operations[op] += dateStats.operations[op];
            }
            
            outputDateSection(dateStr, orders, dateStats);
        }

        // Show dashboard
        showDashboard();
        
        const previewArea = document.getElementById('previewArea');
        previewArea.innerHTML = finalHtml;
        previewArea.style.display = 'block';
        
        document.getElementById('controls').style.display = 'block';
        
        previewArea.scrollIntoView({ behavior: 'smooth' });
    }

    function extractOperation(line, operations) {
        // Extract operation from parentheses or after |
        const match = line.match(/\(([^)]+)\)/i) || line.match(/\|\s*([^|]+?)\s*\|/i);
        if (match) {
            let op = match[1].trim();
            // Clean up operation name
            op = op.replace(/^(—Ä–∞—Å–ø–∏–ª|–≤—Ä–µ–º—è|–¥–µ—Ç–∞–ª—å|—Å—Ç–æ–ª)/i, (m) => m.trim());
            if (op.length > 2 && op.toLowerCase() !== 'x' && !op.match(/^\d+$/)) {
                if (!operations[op]) {
                    operations[op] = 0;
                }
                operations[op]++;
            }
        }
    }

    function showDashboard() {
        document.getElementById('dashboard').classList.add('show');
        document.getElementById('totalOrders').textContent = globalStats.totalOrders;
        document.getElementById('totalM2').textContent = globalStats.totalM2.toFixed(2);
        document.getElementById('totalLM').textContent = globalStats.totalLM.toFixed(2);
        document.getElementById('totalHours').textContent = globalStats.totalHours.toFixed(2);
        
        // Top operations
        const sortedOps = Object.entries(globalStats.operations)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 8);
        
        let opsHtml = '';
        for (let [op, count] of sortedOps) {
            opsHtml += `<span class="operation-tag">${op}: ${count}</span>`;
        }
        document.getElementById('topOperations').innerHTML = opsHtml || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
        
        // Date stats
        let dateHtml = '';
        for (let [date, stats] of Object.entries(globalStats.dates)) {
            dateHtml += `<div class="date-stats">`;
            dateHtml += `<strong>${date}</strong> (${stats.orders} –∑–∞–∫.) | `;
            if (stats.m2 > 0) dateHtml += `${stats.m2.toFixed(2)} –º¬≤ `;
            if (stats.lm > 0) dateHtml += `${stats.lm.toFixed(2)} –º.–ø. `;
            if (stats.hours > 0) dateHtml += `${stats.hours.toFixed(2)} —á`;
            dateHtml += `</div>`;
        }
        document.getElementById('dateStats').innerHTML = dateHtml;
    }

    function outputDateSection(dateStr, orders, dateStats) {
        finalContent += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        finalContent += `–ó–ê–ö–ê–ó–´ –ó–ê ${dateStr} (${orders.length} –∑–∞–∫–∞–∑–æ–≤)\n`;
        finalContent += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        finalContent += `–í—Å–µ–≥–æ: ${dateStats.m2.toFixed(2)} –º¬≤ | ${dateStats.lm.toFixed(2)} –º.–ø. | ${dateStats.hours.toFixed(2)} —á\n\n`;
        
        let ordersHtml = '';
        for (let order of orders) {
            finalContent += `${order.number}\n`;
            
            ordersHtml += `<div class="order-item">`;
            ordersHtml += `<div class="order-number">${order.number}</div>`;
            
            for (let line of order.lines) {
                finalContent += `  ${line}\n`;
                ordersHtml += `<div class="item-line">${highlightLine(line)}</div>`;
            }
            
            if (order.totals.m2 > 0) {
                const text = `–ò–¢–û–ì–û: ${order.totals.m2.toFixed(2)} –º¬≤`;
                finalContent += `  ${text}\n`;
                ordersHtml += `<div class="volume-line">${text}</div>`;
            }
            if (order.totals.lm > 0) {
                const text = `–ò–¢–û–ì–û: ${order.totals.lm.toFixed(2)} –º.–ø.`;
                finalContent += `  ${text}\n`;
                ordersHtml += `<div class="volume-line">${text}</div>`;
            }
            if (order.totals.hours > 0) {
                const text = `–ò–¢–û–ì–û: ${order.totals.hours.toFixed(2)} —á–∞—Å—ã`;
                finalContent += `  ${text}\n`;
                ordersHtml += `<div class="volume-line">${text}</div>`;
            }
            
            ordersHtml += `</div>`;
            finalContent += '\n';
        }
        
        finalHtml += `<div class="date-section">`;
        finalHtml += `<div class="date-header">üìÖ ${dateStr} (${orders.length} –∑–∞–∫. | ${dateStats.m2.toFixed(1)} –º¬≤ | ${dateStats.hours.toFixed(1)} —á)</div>`;
        finalHtml += `<div class="orders-grid">${ordersHtml}</div>`;
        finalHtml += `</div>`;
    }

    function extractVolumes(line, totals) {
        const lowerLine = line.toLowerCase();
        
        if (lowerLine.includes('–æ–±—ä–µ–º:') || lowerLine.includes('–æ–±—ä—ë–º:')) {
            const match = line.match(/–æ–±—ä–µ[–º–ú]:\s*([\d,]+)\s*(–º¬≤|–º2|–º\.–ø\.|–º–ø|—á–∞—Å—ã|—á–∞—Å|—á)/i);
            if (match) {
                const valueStr = match[1].replace(',', '.');
                const value = parseFloat(valueStr);
                const unit = match[2].toLowerCase();
                
                if (!isNaN(value) && value > 0) {
                    if (unit === '–º¬≤' || unit === '–º2') {
                        totals.m2 += value;
                    } else if (unit === '–º.–ø.' || unit === '–º–ø') {
                        totals.lm += value;
                    } else if (unit === '—á–∞—Å—ã' || unit === '—á–∞—Å' || unit === '—á') {
                        totals.hours += value;
                    }
                }
            }
        }
    }

    function highlightLine(line) {
        let result = line;
        result = result.replace(/(x\d+)/gi, '<span class="quantity">$1</span>');
        return result;
    }

    function removePrices(line) {
        let result = line;
        result = result.replace(/\s*\|\s*[\d\s]+,\d{2}\s*‚ÇΩ?/g, '|');
        result = result.replace(/‚ÇΩ/g, '');
        result = result.replace(/\s+\|/g, ' |');
        return result.trim();
    }

    function formatDateFromFile(filename) {
        const patterns = [
            /(\d{4})-(\d{2})-(\d{2})/,
            /(\d{2})\.(\d{2})\.(\d{4})/
        ];

        for (let pattern of patterns) {
            const match = filename.match(pattern);
            if (match) {
                if (pattern.source.includes('\\d{4}-')) {
                    return `${match[3]}.${match[2]}.${match[1]}`;
                } else {
                    return `${match[1]}.${match[2]}.${match[3]}`;
                }
            }
        }
        
        return filename.replace(/\.[^/.]+$/, "").toUpperCase();
    }

    function readFileAsText(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsText(file);
        });
    }

    function extractDate(filename) {
        const patterns = [
            /(\d{4})-(\d{2})-(\d{2})/,
            /(\d{2})\.(\d{2})\.(\d{4})/
        ];

        for (let pattern of patterns) {
            const match = filename.match(pattern);
            if (match) {
                if (pattern.source.includes('\\d{4}-')) {
                    return new Date(`${match[1]}-${match[2]}-${match[3]}`);
                } else {
                    return new Date(`${match[3]}-${match[2]}-${match[1]}`);
                }
            }
        }
        return null;
    }

    function downloadTxt() {
        const blob = new Blob([finalContent], { type: "text/plain;charset=utf-8" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "merged_orders.txt";
        link.click();
    }
</script>

</body>
</html>
