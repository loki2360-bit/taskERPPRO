<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding-top: 40px;
            padding-bottom: 40px;
        }
        .container { 
            max-width: 900px; 
            background: white; 
            padding: 40px; 
            border-radius: 15px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.2); 
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 12px;
            font-weight: 600;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞ */
        #previewArea { 
            display: none; 
            margin-top: 30px; 
            padding: 30px; 
            background: #fff;
            border-radius: 10px;
        }
        
        .date-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            margin: 30px 0 20px 0;
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        .order-block {
            background: #f8f9fa;
            border-left: 5px solid #667eea;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }
        
        .order-block:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .order-number {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            display: inline-block;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 15px;
            box-shadow: 0 3px 10px rgba(245, 87, 108, 0.3);
        }
        
        .order-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #e9ecef;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
        }
        
        .item-type {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 6px 15px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 14px;
            display: inline-block;
        }
        
        .item-material {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: white;
            padding: 6px 15px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 14px;
            display: inline-block;
        }
        
        .item-quantity {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: white;
            padding: 6px 15px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 14px;
            display: inline-block;
            min-width: 60px;
            text-align: center;
        }
        
        .item-detail {
            color: #495057;
            font-size: 14px;
            flex: 1;
            min-width: 200px;
        }
        
        .separator {
            height: 3px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            margin: 30px 0;
            border-radius: 3px;
        }
        
        @media print {
            body * { visibility: hidden; }
            #printSection, #printSection * { visibility: visible; }
            #printSection { 
                position: absolute; 
                left: 0; 
                top: 0; 
                width: 100%;
                background: white;
            }
            .date-header {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                page-break-after: avoid;
            }
            .order-block {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                page-break-inside: avoid;
            }
            .order-number, .item-type, .item-material, .item-quantity {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <h2 class="mb-4 text-center" style="color: #667eea; font-weight: 700;">üì¶ –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤ –ø–æ –¥–∞—Ç–∞–º</h2>
    
    <div class="mb-3">
        <label for="fileInput" class="form-label fw-bold">–í—ã–±–µ—Ä–∏—Ç–µ TXT —Ñ–∞–π–ª—ã (–º–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ä–∞–∑—É):</label>
        <input class="form-control form-control-lg" type="file" id="fileInput" multiple accept=".txt">
        <div class="form-text">–§–∞–π–ª—ã –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–æ –¥–∞—Ç–µ</div>
    </div>

    <button class="btn btn-primary btn-lg w-100" onclick="processFiles()">‚ú® –û–±—ä–µ–¥–∏–Ω–∏—Ç—å –∏ –æ—Ñ–æ—Ä–º–∏—Ç—å</button>

    <div id="printSection" style="margin-top: 30px;">
        <div id="previewArea"></div>
    </div>
    
    <div id="controls" style="display:none; margin-top: 30px; border-top: 3px solid #667eea; padding-top: 20px;">
        <button class="btn btn-success btn-lg me-2" onclick="window.print()">üñ®Ô∏è –ü–µ—á–∞—Ç—å / PDF</button>
        <button class="btn btn-outline-primary btn-lg" onclick="downloadTxt()">üíæ –°–∫–∞—á–∞—Ç—å TXT</button>
    </div>
</div>

<script>
    let finalContent = "";
    let finalHtml = "";

    async function processFiles() {
        const fileInput = document.getElementById('fileInput');
        const files = Array.from(fileInput.files);

        if (files.length === 0) {
            alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ñ–∞–π–ª.");
            return;
        }

        files.sort((a, b) => {
            const dateA = extractDate(a.name);
            const dateB = extractDate(b.name);
            
            if (dateA && dateB) {
                return dateA - dateB;
            }
            return a.name.localeCompare(b.name);
        });

        finalContent = "";
        finalHtml = "";
        
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const text = await readFileAsText(file);
            
            const dateStr = formatDateFromFile(file.name);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–∞—Ç—ã
            finalHtml += `<div class="date-header">üìÖ –ó–∞–∫–∞–∑—ã –∑–∞ ${dateStr}</div>`;
            finalContent += `–ó–ê–ö–ê–ó–´ –ó–ê ${dateStr}\n${'='.repeat(50)}\n\n`;
            
            const lines = text.split('\n');
            let currentOrder = null;
            let orderItems = [];
            
            for (let line of lines) {
                const trimmed = line.trim();
                if (!trimmed) continue;
                
                // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏
                if (trimmed.toLowerCase().includes('–∑–∞–∫–∞–∑—ã –∑–∞')) continue;
                if (/^[‚ïê=]+$/.test(trimmed)) continue;
                if (trimmed.includes('–ò—Ç–æ–≥–æ –ø–æ –∑–∞–∫–∞–∑—É')) continue;
                if (trimmed.includes('–û–±—â–∞—è —Å—É–º–º–∞ –∑–∞ –¥–µ–Ω—å')) continue;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —ç—Ç–æ –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞
                const orderMatch = trimmed.match(/–∑–∞–∫–∞–∑\s*‚Ññ?(\d+)/i);
                if (orderMatch) {
                    // –ï—Å–ª–∏ –±—ã–ª –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∑–∞–∫–∞–∑, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ–≥–æ
                    if (currentOrder && orderItems.length > 0) {
                        addOrderToOutput(currentOrder, orderItems);
                    }
                    currentOrder = orderMatch[1];
                    orderItems = [];
                    continue;
                }
                
                // –ü–∞—Ä—Å–∏–º —Å—Ç—Ä–æ–∫—É —Å —ç–ª–µ–º–µ–Ω—Ç–æ–º –∑–∞–∫–∞–∑–∞
                if (trimmed.startsWith('-')) {
                    const item = parseOrderItem(trimmed);
                    if (item) {
                        orderItems.push(item);
                    }
                }
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–∫–∞–∑
            if (currentOrder && orderItems.length > 0) {
                addOrderToOutput(currentOrder, orderItems);
            }
            
            if (i < files.length - 1) {
                finalHtml += `<div class="separator"></div>`;
            }
        }

        const previewArea = document.getElementById('previewArea');
        previewArea.innerHTML = finalHtml;
        previewArea.style.display = 'block';
        
        document.getElementById('controls').style.display = 'block';
        
        previewArea.scrollIntoView({ behavior: 'smooth' });
    }

    function parseOrderItem(line) {
        // –£–±–∏—Ä–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–π "-"
        let content = line.replace(/^\s*-\s*/, '');
        
        const item = {
            type: '',
            material: '',
            quantity: '',
            details: []
        };
        
        // –†–∞–∑–±–∏–≤–∞–µ–º –ø–æ |
        const parts = content.split('|').map(p => p.trim()).filter(p => p);
        
        for (let part of parts) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (x1, x2 –∏ —Ç.–¥.)
            if (/^x\d+$/i.test(part)) {
                item.quantity = part.toUpperCase();
                continue;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø (—Ä–∞—Å–ø–∏–ª, –ª–∏–Ω–µ–π–Ω—ã–π —Ä–∞—Å–ø–∏–ª –∏ —Ç.–¥.)
            if (part.toLowerCase().includes('—Ä–∞—Å–ø–∏–ª') || 
                part.toLowerCase().includes('–¥–µ—Ç–∞–ª—å') ||
                part.toLowerCase().includes('—Å—Ç–æ–ª')) {
                item.type = part;
                continue;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª (–º–¥—Ñ, –ª–¥—Å–ø –∏ —Ç.–¥.)
            if (part.toLowerCase().includes('–º–¥—Ñ') || 
                part.toLowerCase().includes('–ª–¥—Å–ø') ||
                part.toLowerCase().includes('–º–º')) {
                item.material = part;
                continue;
            }
            
            // –û—Å—Ç–∞–ª—å–Ω–æ–µ - –¥–µ—Ç–∞–ª–∏
            if (part && !/^\d/.test(part)) {
                item.details.push(part);
            }
        }
        
        return item;
    }

    function addOrderToOutput(orderNumber, items) {
        // HTML –≤–µ—Ä—Å–∏—è
        let itemsHtml = '';
        for (let item of items) {
            itemsHtml += `
                <div class="order-item">
                    ${item.type ? `<span class="item-type">üîß ${item.type}</span>` : ''}
                    ${item.material ? `<span class="item-material">üìã ${item.material}</span>` : ''}
                    ${item.quantity ? `<span class="item-quantity">${item.quantity}</span>` : ''}
                    ${item.details.length > 0 ? `<span class="item-detail">${item.details.join(' ‚Üí ')}</span>` : ''}
                </div>
            `;
        }
        
        finalHtml += `
            <div class="order-block">
                <div class="order-number">üìã –ó–∞–∫–∞–∑ ‚Ññ${orderNumber}</div>
                ${itemsHtml}
            </div>
        `;
        
        // –¢–µ–∫—Å—Ç–æ–≤–∞—è –≤–µ—Ä—Å–∏—è
        finalContent += `–ó–∞–∫–∞–∑ ‚Ññ${orderNumber}\n`;
        for (let item of items) {
            let line = '  - ';
            if (item.type) line += `[${item.type}] `;
            if (item.material) line += `{${item.material}} `;
            if (item.quantity) line += `√ó${item.quantity} `;
            if (item.details.length > 0) line += item.details.join(' ‚Üí ');
            finalContent += line + '\n';
        }
        finalContent += '\n';
    }

    function formatDateFromFile(filename) {
        const patterns = [
            /(\d{4})-(\d{2})-(\d{2})/,
            /(\d{2})\.(\d{2})\.(\d{4})/
        ];

        for (let pattern of patterns) {
            const match = filename.match(pattern);
            if (match) {
                if (pattern.source.includes('\\d{4}-')) {
                    return `${match[3]}.${match[2]}.${match[1]}`;
                } else {
                    return `${match[1]}.${match[2]}.${match[3]}`;
                }
            }
        }
        
        return filename.replace(/\.[^/.]+$/, "").toUpperCase();
    }

    function readFileAsText(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsText(file);
        });
    }

    function extractDate(filename) {
        const patterns = [
            /(\d{4})-(\d{2})-(\d{2})/,
            /(\d{2})\.(\d{2})\.(\d{4})/
        ];

        for (let pattern of patterns) {
            const match = filename.match(pattern);
            if (match) {
                if (pattern.source.includes('\\d{4}-')) {
                    return new Date(`${match[1]}-${match[2]}-${match[3]}`);
                } else {
                    return new Date(`${match[3]}-${match[2]}-${match[1]}`);
                }
            }
        }
        return null;
    }

    function downloadTxt() {
        const blob = new Blob([finalContent], { type: "text/plain;charset=utf-8" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "merged_orders.txt";
        link.click();
    }
</script>

</body>
</html>
