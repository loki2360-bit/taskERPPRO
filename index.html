<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; padding-top: 40px; }
        .container { max-width: 800px; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        #previewArea { 
            display: none; 
            margin-top: 20px; 
            border: 1px solid #ddd; 
            padding: 20px; 
            background: #fff;
            font-family: 'Courier New', Courier, monospace;
            white-space: pre-wrap;
            line-height: 1.6;
        }
        
        /* –¶–≤–µ—Ç–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
        .date-header { 
            color: #d63384; 
            font-weight: bold;
            background-color: #f8d7da;
            padding: 2px 8px;
            border-radius: 4px;
        }
        .order-number { 
            color: #0d6efd; 
            font-weight: bold;
        }
        .item-name { 
            color: #198754;
        }
        .quantity { 
            color: #fd7e14;
            font-weight: bold;
        }
        .separator { 
            color: #6c757d;
        }
        .order-total {
            color: #6f42c1;
            font-weight: bold;
            background-color: #e9d8fd;
            padding: 2px 8px;
            border-radius: 4px;
            margin-top: 5px;
        }
        
        @media print {
            body * { visibility: hidden; }
            #printSection, #printSection * { visibility: visible; }
            #printSection { position: absolute; left: 0; top: 0; width: 100%; }
            .date-header, .order-total { 
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <h2 class="mb-4 text-center">üì¶ –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤ –ø–æ –¥–∞—Ç–∞–º</h2>
    
    <div class="mb-3">
        <label for="fileInput" class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ TXT —Ñ–∞–π–ª—ã (–º–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ä–∞–∑—É):</label>
        <input class="form-control" type="file" id="fileInput" multiple accept=".txt">
        <div class="form-text">–§–∞–π–ª—ã –±—É–¥—É—Ç –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</div>
    </div>

    <button class="btn btn-primary w-100" onclick="processFiles()">–û–±—ä–µ–¥–∏–Ω–∏—Ç—å –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –∫ –ø–µ—á–∞—Ç–∏</button>

    <div id="printSection" style="margin-top: 30px;">
        <div id="previewArea"></div>
    </div>
    
    <div id="controls" style="display:none; margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px;">
        <button class="btn btn-success me-2" onclick="window.print()">üñ®Ô∏è –ü–µ—á–∞—Ç—å / PDF</button>
        <button class="btn btn-outline-secondary" onclick="downloadTxt()">üíæ –°–∫–∞—á–∞—Ç—å –æ–±—â–∏–π TXT</button>
    </div>
</div>

<script>
    let finalContent = "";
    let finalHtml = "";

    async function processFiles() {
        const fileInput = document.getElementById('fileInput');
        const files = Array.from(fileInput.files);

        if (files.length === 0) {
            alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ñ–∞–π–ª.");
            return;
        }

        files.sort((a, b) => {
            const dateA = extractDate(a.name);
            const dateB = extractDate(b.name);
            
            if (dateA && dateB) {
                return dateA - dateB;
            }
            return a.name.localeCompare(b.name);
        });

        finalContent = "";
        finalHtml = "";
        
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const text = await readFileAsText(file);
            
            // –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞—Ç—É –∏–∑ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
            const dateStr = formatDateFromFile(file.name);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å –¥–∞—Ç–æ–π
            if (i > 0) {
                finalContent += '\n';
                finalHtml += '<br>';
            }
            
            const separator = '‚ïê'.repeat(50);
            finalContent += separator + '\n';
            finalContent += `–ó–ê–ö–ê–ó–´ –ó–ê ${dateStr}\n`;
            finalContent += separator + '\n\n';
            
            finalHtml += `<div class="separator">${separator}</div>`;
            finalHtml += `<div class="date-header">–ó–ê–ö–ê–ó–´ –ó–ê ${dateStr}</div>`;
            finalHtml += `<div class="separator">${separator}</div><br>`;
            
            // –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —Å—Ç—Ä–æ–∫–∏
            const lines = text.split('\n');
            let currentOrder = [];
            let orderTotals = { m2: 0, lm: 0, hours: 0 };
            let inOrder = false;
            
            for (let j = 0; j < lines.length; j++) {
                const trimmed = lines[j].trim();
                
                // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
                if (trimmed.length === 0) continue;
                
                // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Å –¥–∞—Ç–∞–º–∏ –∏–∑ –∏—Å—Ö–æ–¥–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
                if (trimmed.toLowerCase().includes('–∑–∞–∫–∞–∑—ã –∑–∞')) continue;
                
                // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
                if (/^[‚ïê=-]+$/.test(trimmed)) continue;
                
                // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å—Ç—Ä–æ–∫–∏ —Å —Å—É–º–º–∞–º–∏ –∏ –∏—Ç–æ–≥–∞–º–∏
                if (trimmed.toLowerCase().includes('—Å—É–º–º–∞:')) continue;
                if (trimmed.toLowerCase().includes('–∏—Ç–æ–≥–æ:')) continue;
                if (trimmed.toLowerCase().includes('–∏—Ç–æ–≥–æ –ø–æ –∑–∞–∫–∞–∑—É')) continue;
                if (trimmed.toLowerCase().includes('–æ–±—â–∞—è —Å—É–º–º–∞ –∑–∞ –¥–µ–Ω—å')) continue;
                if (trimmed.toLowerCase().includes('—ç–∫—Å–ø–æ—Ä—Ç:')) continue;
                
                // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–¥–µ—Ä–∂–∞—Ç —Ç–æ–ª—å–∫–æ "undefined" –∏–ª–∏ "NaN"
                if (trimmed.includes('undefined') || trimmed.includes('NaN')) continue;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ª–∏ –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑ (—Å—Ç—Ä–æ–∫–∞ —Å ‚Ññ)
                if (/^‚Ññ\s*\d/i.test(trimmed)) {
                    // –ï—Å–ª–∏ –±—ã–ª –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∑–∞–∫–∞–∑, –≤—ã–≤–æ–¥–∏–º –µ–≥–æ –∏—Ç–æ–≥–∏
                    if (inOrder && currentOrder.length > 0) {
                        outputOrder(currentOrder, orderTotals);
                    }
                    // –ù–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑
                    currentOrder = [];
                    orderTotals = { m2: 0, lm: 0, hours: 0 };
                    inOrder = true;
                }
                
                // –ò–∑–≤–ª–µ–∫–∞–µ–º –æ–±—ä–µ–º—ã –∏–∑ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–æ–∫–∏
                extractVolumes(trimmed, orderTotals);
                
                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫—É (—É–±–∏—Ä–∞–µ–º —Ü–µ–Ω—ã)
                let processedLine = removePrices(trimmed);
                
                if (processedLine.length > 0 && inOrder) {
                    currentOrder.push(processedLine);
                }
            }
            
            // –í—ã–≤–æ–¥–∏–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–∫–∞–∑ –≤ —Ñ–∞–π–ª–µ
            if (inOrder && currentOrder.length > 0) {
                outputOrder(currentOrder, orderTotals);
            }
        }

        const previewArea = document.getElementById('previewArea');
        previewArea.innerHTML = finalHtml;
        previewArea.style.display = 'block';
        
        document.getElementById('controls').style.display = 'block';
        
        previewArea.scrollIntoView({ behavior: 'smooth' });
    }

    // –§—É–Ω–∫—Ü–∏—è –≤—ã–≤–æ–¥–∞ –∑–∞–∫–∞–∑–∞ —Å –∏—Ç–æ–≥–∞–º–∏
    function outputOrder(orderLines, totals) {
        // –í—ã–≤–æ–¥–∏–º —Å—Ç—Ä–æ–∫–∏ –∑–∞–∫–∞–∑–∞
        for (let line of orderLines) {
            finalContent += line + '\n';
            finalHtml += highlightLine(line) + '<br>';
        }
        
        // –í—ã–≤–æ–¥–∏–º –∏—Ç–æ–≥–∏ –ø–æ –∑–∞–∫–∞–∑—É
        let hasTotals = false;
        let totalText = '';
        let totalHtml = '';
        
        if (totals.m2 > 0) {
            const text = `–ò–¢–û–ì–û: ${totals.m2.toFixed(2)} –º¬≤`;
            finalContent += text + '\n';
            totalHtml += `<span class="order-total">${text}</span> `;
            hasTotals = true;
        }
        
        if (totals.lm > 0) {
            const text = `–ò–¢–û–ì–û: ${totals.lm.toFixed(2)} –º.–ø.`;
            finalContent += text + '\n';
            totalHtml += `<span class="order-total">${text}</span> `;
            hasTotals = true;
        }
        
        if (totals.hours > 0) {
            const text = `–ò–¢–û–ì–û: ${totals.hours.toFixed(2)} —á–∞—Å—ã`;
            finalContent += text + '\n';
            totalHtml += `<span class="order-total">${text}</span> `;
            hasTotals = true;
        }
        
        if (hasTotals) {
            finalContent += '\n';
            finalHtml += totalHtml + '<br><br>';
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –æ–±—ä–µ–º–æ–≤ –∏–∑ —Å—Ç—Ä–æ–∫–∏
    function extractVolumes(line, totals) {
        const lowerLine = line.toLowerCase();
        
        // –ò—â–µ–º —Å—Ç—Ä–æ–∫–∏ —Å "–û–±—ä–µ–º:" –∏–ª–∏ "–û–±—ä—ë–º:"
        if (lowerLine.includes('–æ–±—ä–µ–º:') || lowerLine.includes('–æ–±—ä—ë–º:')) {
            // –ò–∑–≤–ª–µ–∫–∞–µ–º —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏ –µ–¥–∏–Ω–∏—Ü—É –∏–∑–º–µ—Ä–µ–Ω–∏—è
            // –ü–∞—Ç—Ç–µ—Ä–Ω: –û–±—ä–µ–º: X –º¬≤ –∏–ª–∏ –û–±—ä–µ–º: X —á–∞—Å—ã
            const match = line.match(/–æ–±—ä–µ[–º–ú]:\s*([\d,]+)\s*(–º¬≤|–º2|–º\.–ø\.|–º–ø|—á–∞—Å—ã|—á–∞—Å|—á)/i);
            if (match) {
                const valueStr = match[1].replace(',', '.');
                const value = parseFloat(valueStr);
                const unit = match[2].toLowerCase();
                
                if (!isNaN(value) && value > 0) {
                    if (unit === '–º¬≤' || unit === '–º2') {
                        totals.m2 += value;
                    } else if (unit === '–º.–ø.' || unit === '–º–ø') {
                        totals.lm += value;
                    } else if (unit === '—á–∞—Å—ã' || unit === '—á–∞—Å' || unit === '—á') {
                        totals.hours += value;
                    }
                }
            }
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ —Å—Ç—Ä–æ–∫–µ
    function highlightLine(line) {
        let result = line;
        
        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –Ω–æ–º–µ—Ä–æ–≤ –∑–∞–∫–∞–∑–æ–≤ (‚Ññ...)
        result = result.replace(/(‚Ññ\s*[\d\s-]+)/g, '<span class="order-number">$1</span>');
        
        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ (x1, x2 –∏ —Ç.–¥.)
        result = result.replace(/(x\d+)/gi, '<span class="quantity">$1</span>');
        
        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–π |
        result = result.replace(/\|/g, '<span class="separator">|</span>');
        
        return result;
    }

    // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è —Ü–µ–Ω –∏–∑ —Å—Ç—Ä–æ–∫–∏
    function removePrices(line) {
        let result = line;
        
        // –£–¥–∞–ª—è–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã —Å —Ü–µ–Ω–∞–º–∏: —á–∏—Å–ª–∞ —Å –ø—Ä–æ–±–µ–ª–∞–º–∏, –∑–∞–ø—è—Ç–æ–π –∏ ‚ÇΩ
        result = result.replace(/\s*\|\s*[\d\s]+,\d{2}\s*‚ÇΩ?/g, '|');
        
        // –£–¥–∞–ª—è–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è ‚ÇΩ —Å–∏–º–≤–æ–ª—ã
        result = result.replace(/‚ÇΩ/g, '');
        
        // –£–¥–∞–ª—è–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã –ø–µ—Ä–µ–¥ |
        result = result.replace(/\s+\|/g, ' |');
        
        return result.trim();
    }

    // –§—É–Ω–∫—Ü–∏—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã –∏–∑ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
    function formatDateFromFile(filename) {
        const patterns = [
            /(\d{4})-(\d{2})-(\d{2})/,  // YYYY-MM-DD
            /(\d{2})\.(\d{2})\.(\d{4})/  // DD.MM.YYYY
        ];

        for (let pattern of patterns) {
            const match = filename.match(pattern);
            if (match) {
                if (pattern.source.includes('\\d{4}-')) {
                    // YYYY-MM-DD -> DD.MM.YYYY
                    return `${match[3]}.${match[2]}.${match[1]}`;
                } else {
                    // DD.MM.YYYY -> DD.MM.YYYY
                    return `${match[1]}.${match[2]}.${match[3]}`;
                }
            }
        }
        
        // –ï—Å–ª–∏ –¥–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
        return filename.replace(/\.[^/.]+$/, "").toUpperCase();
    }

    function readFileAsText(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsText(file);
        });
    }

    function extractDate(filename) {
        const patterns = [
            /(\d{4})-(\d{2})-(\d{2})/,
            /(\d{2})\.(\d{2})\.(\d{4})/
        ];

        for (let pattern of patterns) {
            const match = filename.match(pattern);
            if (match) {
                if (pattern.source.includes('\\d{4}-')) {
                    return new Date(`${match[1]}-${match[2]}-${match[3]}`);
                } else {
                    return new Date(`${match[3]}-${match[2]}-${match[1]}`);
                }
            }
        }
        return null;
    }

    function downloadTxt() {
        const blob = new Blob([finalContent], { type: "text/plain;charset=utf-8" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "merged_orders.txt";
        link.click();
    }
</script>

</body>
</html>
